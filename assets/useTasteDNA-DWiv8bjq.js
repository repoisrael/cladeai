import{s as p,a as A,g as b}from"./index-Dj8i9Zc4.js";async function q(t){var m;try{const[a,g]=await Promise.all([p.from("play_history").select("track_id, tracks!inner(*)").eq("user_id",t).order("played_at",{ascending:!1}).limit(200),p.from("user_interactions").select("track_id, tracks!inner(*)").eq("user_id",t).in("interaction_type",["like","save"]).order("created_at",{ascending:!1}).limit(100)]),f=(a.data||[]).map(e=>e.tracks).filter(Boolean),y=(g.data||[]).map(e=>e.tracks).filter(Boolean),u=new Map;[...f,...y].forEach(e=>{e!=null&&e.id&&u.set(e.id,e)});const n=Array.from(u.values());if(n.length===0)return null;const i=new Map;n.forEach(e=>{if(e.progression_roman&&e.progression_roman.length>0){const r=e.progression_roman.join("→"),s=i.get(r);s?(s.count++,s.tracks.push(e.id)):i.set(r,{count:1,tracks:[e.id]})}});const h=Array.from(i.entries()).map(([e,r])=>({progression:e.split("→"),count:r.count,tracks:r.tracks})).sort((e,r)=>r.count-e.count).slice(0,5),o=n.reduce((e,r)=>(r.detected_mode==="major"?e.major++:r.detected_mode==="minor"&&e.minor++,e),{major:0,minor:0}),c=o.major+o.minor,_=c>0?[{mode:"major",percentage:Math.round(o.major/c*100),count:o.major},{mode:"minor",percentage:Math.round(o.minor/c*100),count:o.minor}].sort((e,r)=>r.percentage-e.percentage):[],l=n.filter(e=>typeof e.energy=="number").map(e=>e.energy),j=l.length>0?l.reduce((e,r)=>e+r,0)/l.length:.5,M=n.reduce((e,r)=>{const s=r.cadence_type||"loop";return e[s]=(e[s]||0)+1,e},{}),T=((m=Object.entries(M).sort((e,r)=>r[1]-e[1])[0])==null?void 0:m[0])||"loop",d=n.filter(e=>typeof e.tempo=="number").map(e=>e.tempo),k=d.length>0?Math.round(d.reduce((e,r)=>e+r,0)/d.length):120;return{favoriteProgressions:h,preferredModes:_,energyPreference:j,cadencePreference:T,averageTempo:k,totalTracksAnalyzed:n.length}}catch(a){return console.error("Error computing taste DNA:",a),null}}function v(){const{user:t}=A();return b({queryKey:["taste-dna",t==null?void 0:t.id],queryFn:async()=>t!=null&&t.id?q(t.id):null,enabled:!!(t!=null&&t.id),staleTime:5*60*1e3,gcTime:10*60*1e3})}export{v as u};
