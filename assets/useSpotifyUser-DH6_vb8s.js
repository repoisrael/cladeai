import{o as v,p as g,q,a as y,g as h}from"./index-DR2ZT8QU.js";function C(e,t){e(`/track/${encodeURIComponent(t)}`)}const _="https://api.spotify.com/v1";function k(e){const{track:t}=e,n=t.album.images.sort((r,a)=>a.height-r.height)[0];return{id:`spotify:${t.id}`,title:t.name,artist:t.artists.map(r=>r.name).join(", "),artists:t.artists.map(r=>r.name),album:t.album.name,cover_url:n==null?void 0:n.url,artwork_url:n==null?void 0:n.url,duration_ms:t.duration_ms,spotify_id:t.id,url_spotify_web:t.external_urls.spotify,url_spotify_app:t.uri,preview_url:t.preview_url,provider:"spotify",external_id:t.id,played_at:e.played_at}}async function $(e,t=20){const n=await g(e);if(!n)return null;try{const r=new URLSearchParams({limit:Math.min(t,50).toString()}),a=await fetch(`${_}/me/player/recently-played?${r}`,{headers:{Authorization:`Bearer ${n}`}});if(!a.ok)return a.status===401?await q(e,"")?$(e,t):(console.error("Spotify token refresh failed"),null):(console.error("Failed to fetch recently played:",a.status),null);const i=await a.json(),c=[],o=new Set;for(const m of i.items){const d=k(m),s=d.spotify_id||d.id;if(s&&!o.has(s)&&(o.add(s),c.push(d)),c.length>=t)break}return{tracks:c.slice(0,t),source:"spotify"}}catch(r){return console.error("Error fetching recently played:",r),null}}async function A(e){return await v(e)!==null}async function j(e){var n,r,a;const t=await g(e);if(!t)return null;try{const i=await fetch(`${_}/me`,{headers:{Authorization:`Bearer ${t}`}});if(!i.ok)return null;const c=await i.json();return{displayName:c.display_name||c.id,email:c.email,imageUrl:(r=(n=c.images)==null?void 0:n[0])==null?void 0:r.url,product:c.product,followers:(a=c.followers)==null?void 0:a.total}}catch(i){return console.error("Error fetching Spotify profile:",i),null}}async function b(e,t="medium_term",n=20){const r=await g(e);if(!r)return[];try{const a=new URLSearchParams({time_range:t,limit:Math.min(n,50).toString()}),i=await fetch(`${_}/me/top/tracks?${a}`,{headers:{Authorization:`Bearer ${r}`}});return i.ok?(await i.json()).items.map(o=>{var m,d;return{id:`spotify:${o.id}`,title:o.name,artist:o.artists.map(s=>s.name).join(", "),artists:o.artists.map(s=>s.name),album:o.album.name,cover_url:(m=o.album.images[0])==null?void 0:m.url,artwork_url:(d=o.album.images[0])==null?void 0:d.url,duration_ms:o.duration_ms,spotify_id:o.id,provider:"spotify",external_id:o.id}}):[]}catch(a){return console.error("Error fetching top tracks:",a),[]}}async function S(e,t="medium_term",n=20){const r=await g(e);if(!r)return[];try{const a=new URLSearchParams({time_range:t,limit:Math.min(n,50).toString()}),i=await fetch(`${_}/me/top/artists?${a}`,{headers:{Authorization:`Bearer ${r}`}});return i.ok?(await i.json()).items:[]}catch(a){return console.error("Error fetching top artists:",a),[]}}async function F(e,t){if(t.length===0)return[];const n=await g(e);if(!n)return[];try{const r=t.slice(0,100).join(","),a=await fetch(`${_}/audio-features?ids=${r}`,{headers:{Authorization:`Bearer ${n}`}});return a.ok?(await a.json()).audio_features.filter(Boolean):[]}catch(r){return console.error("Error fetching audio features:",r),[]}}async function P(e){const[t,n]=await Promise.all([b(e,"medium_term",50),S(e,"medium_term",50)]);if(t.length===0)return null;const r=t.map(u=>u.spotify_id||u.external_id).filter(Boolean),a=await F(e,r);if(a.length===0)return null;const i=a.reduce((u,l)=>u+l.energy,0)/a.length,c=a.reduce((u,l)=>u+l.danceability,0)/a.length,o=a.reduce((u,l)=>u+l.valence,0)/a.length,m=a.reduce((u,l)=>u+l.tempo,0)/a.length,d={};n.forEach(u=>{u.genres.forEach(l=>{d[l]=(d[l]||0)+1})});const s=Object.entries(d).sort((u,l)=>l[1]-u[1]).slice(0,10).map(([u,l])=>({genre:u,count:l}));let f="balanced";i>.7&&o>.6?f="energetic":i<.4&&o>.5?f="chill":o<.35?f="melancholic":o>.65&&c>.6&&(f="upbeat");const p=new Set(t.flatMap(u=>u.artists||[])),w=Math.min(p.size/t.length,1);return{topGenres:s,averageEnergy:i,averageDanceability:c,averageValence:o,averageTempo:m,moodProfile:f,listeningDiversity:w}}async function E(e,t=[],n=[],r=20){const a=await g(e);if(!a)return[];try{let i=t,c=n;if(i.length===0&&c.length===0){const[s,f]=await Promise.all([b(e,"medium_term",5),S(e,"medium_term",5)]);i=s.slice(0,2).map(p=>p.spotify_id||p.external_id).filter(Boolean),c=f.slice(0,3).map(p=>p.id)}const o=[];if(i.length>0&&o.push(`seed_tracks=${i.slice(0,2).join(",")}`),c.length>0&&o.push(`seed_artists=${c.slice(0,3).join(",")}`),o.length===0)return[];const m=await fetch(`${_}/recommendations?${o.join("&")}&limit=${r}`,{headers:{Authorization:`Bearer ${a}`}});return m.ok?(await m.json()).tracks.map(s=>{var f,p;return{id:`spotify:${s.id}`,title:s.name,artist:s.artists.map(w=>w.name).join(", "),artists:s.artists.map(w=>w.name),album:s.album.name,cover_url:(f=s.album.images[0])==null?void 0:f.url,artwork_url:(p=s.album.images[0])==null?void 0:p.url,duration_ms:s.duration_ms,spotify_id:s.id,provider:"spotify",external_id:s.id}}):[]}catch(i){return console.error("Error fetching recommendations:",i),[]}}function T(){const{user:e}=y();return h({queryKey:["spotify-connected",e==null?void 0:e.id],queryFn:()=>A(e.id),enabled:!!e,staleTime:5*60*1e3})}function x(e=20){const{user:t}=y();return h({queryKey:["spotify-recently-played",t==null?void 0:t.id,e],queryFn:()=>$(t.id,e),enabled:!!t,staleTime:2*60*1e3,refetchOnWindowFocus:!0})}function z(){const{user:e}=y();return h({queryKey:["spotify-profile",e==null?void 0:e.id],queryFn:()=>j(e.id),enabled:!!e,staleTime:10*60*1e3})}function K(e="medium_term",t=20){const{user:n}=y(),{data:r}=T();return h({queryKey:["spotify-top-tracks",n==null?void 0:n.id,e,t],queryFn:()=>b(n.id,e,t),enabled:!!n&&r===!0,staleTime:10*60*1e3})}function M(e="medium_term",t=20){const{user:n}=y(),{data:r}=T();return h({queryKey:["spotify-top-artists",n==null?void 0:n.id,e,t],queryFn:()=>S(n.id,e,t),enabled:!!n&&r===!0,staleTime:10*60*1e3})}function R(){const{user:e}=y(),{data:t}=T();return h({queryKey:["music-stats",e==null?void 0:e.id],queryFn:()=>P(e.id),enabled:!!e&&t===!0,staleTime:30*60*1e3})}function U(e=[],t=[],n=20){const{user:r}=y(),{data:a}=T();return h({queryKey:["spotify-recommendations",r==null?void 0:r.id,e,t,n],queryFn:()=>E(r.id,e,t,n),enabled:!!r&&a===!0,staleTime:15*60*1e3})}export{z as a,K as b,M as c,x as d,R as e,U as f,C as n,T as u};
