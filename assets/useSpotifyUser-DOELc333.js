import{o as g,p as v,q,a as y,g as h}from"./index-BI6e5KKd.js";function C(e,t){e(`/track/${encodeURIComponent(t)}`)}const _="https://api.spotify.com/v1";function k(e){const{track:t}=e,r=t.album.images.sort((n,a)=>a.height-n.height)[0];return{id:`spotify:${t.id}`,title:t.name,artist:t.artists.map(n=>n.name).join(", "),artists:t.artists.map(n=>n.name),album:t.album.name,cover_url:r==null?void 0:r.url,artwork_url:r==null?void 0:r.url,duration_ms:t.duration_ms,spotify_id:t.id,url_spotify_web:t.external_urls.spotify,url_spotify_app:t.uri,preview_url:t.preview_url,provider:"spotify",external_id:t.id}}async function $(e,t=20){const r=await g(e);if(!r)return null;try{const n=new URLSearchParams({limit:Math.min(t,50).toString()}),a=await fetch(`${_}/me/player/recently-played?${n}`,{headers:{Authorization:`Bearer ${r}`}});return a.ok?{tracks:(await a.json()).items.map(k),source:"spotify"}:a.status===401?await v(e,"")?$(e,t):(console.error("Spotify token refresh failed"),null):(console.error("Failed to fetch recently played:",a.status),null)}catch(n){return console.error("Error fetching recently played:",n),null}}async function A(e){return await q(e)!==null}async function j(e){var r,n,a;const t=await g(e);if(!t)return null;try{const i=await fetch(`${_}/me`,{headers:{Authorization:`Bearer ${t}`}});if(!i.ok)return null;const u=await i.json();return{displayName:u.display_name||u.id,email:u.email,imageUrl:(n=(r=u.images)==null?void 0:r[0])==null?void 0:n.url,product:u.product,followers:(a=u.followers)==null?void 0:a.total}}catch(i){return console.error("Error fetching Spotify profile:",i),null}}async function b(e,t="medium_term",r=20){const n=await g(e);if(!n)return[];try{const a=new URLSearchParams({time_range:t,limit:Math.min(r,50).toString()}),i=await fetch(`${_}/me/top/tracks?${a}`,{headers:{Authorization:`Bearer ${n}`}});return i.ok?(await i.json()).items.map(o=>{var f,p;return{id:`spotify:${o.id}`,title:o.name,artist:o.artists.map(s=>s.name).join(", "),artists:o.artists.map(s=>s.name),album:o.album.name,cover_url:(f=o.album.images[0])==null?void 0:f.url,artwork_url:(p=o.album.images[0])==null?void 0:p.url,duration_ms:o.duration_ms,spotify_id:o.id,provider:"spotify",external_id:o.id}}):[]}catch(a){return console.error("Error fetching top tracks:",a),[]}}async function S(e,t="medium_term",r=20){const n=await g(e);if(!n)return[];try{const a=new URLSearchParams({time_range:t,limit:Math.min(r,50).toString()}),i=await fetch(`${_}/me/top/artists?${a}`,{headers:{Authorization:`Bearer ${n}`}});return i.ok?(await i.json()).items:[]}catch(a){return console.error("Error fetching top artists:",a),[]}}async function F(e,t){if(t.length===0)return[];const r=await g(e);if(!r)return[];try{const n=t.slice(0,100).join(","),a=await fetch(`${_}/audio-features?ids=${n}`,{headers:{Authorization:`Bearer ${r}`}});return a.ok?(await a.json()).audio_features.filter(Boolean):[]}catch(n){return console.error("Error fetching audio features:",n),[]}}async function P(e){const[t,r]=await Promise.all([b(e,"medium_term",50),S(e,"medium_term",50)]);if(t.length===0)return null;const n=t.map(c=>c.spotify_id||c.external_id).filter(Boolean),a=await F(e,n);if(a.length===0)return null;const i=a.reduce((c,l)=>c+l.energy,0)/a.length,u=a.reduce((c,l)=>c+l.danceability,0)/a.length,o=a.reduce((c,l)=>c+l.valence,0)/a.length,f=a.reduce((c,l)=>c+l.tempo,0)/a.length,p={};r.forEach(c=>{c.genres.forEach(l=>{p[l]=(p[l]||0)+1})});const s=Object.entries(p).sort((c,l)=>l[1]-c[1]).slice(0,10).map(([c,l])=>({genre:c,count:l}));let m="balanced";i>.7&&o>.6?m="energetic":i<.4&&o>.5?m="chill":o<.35?m="melancholic":o>.65&&u>.6&&(m="upbeat");const d=new Set(t.flatMap(c=>c.artists||[])),w=Math.min(d.size/t.length,1);return{topGenres:s,averageEnergy:i,averageDanceability:u,averageValence:o,averageTempo:f,moodProfile:m,listeningDiversity:w}}async function E(e,t=[],r=[],n=20){const a=await g(e);if(!a)return[];try{let i=t,u=r;if(i.length===0&&u.length===0){const[s,m]=await Promise.all([b(e,"medium_term",5),S(e,"medium_term",5)]);i=s.slice(0,2).map(d=>d.spotify_id||d.external_id).filter(Boolean),u=m.slice(0,3).map(d=>d.id)}const o=[];if(i.length>0&&o.push(`seed_tracks=${i.slice(0,2).join(",")}`),u.length>0&&o.push(`seed_artists=${u.slice(0,3).join(",")}`),o.length===0)return[];const f=await fetch(`${_}/recommendations?${o.join("&")}&limit=${n}`,{headers:{Authorization:`Bearer ${a}`}});return f.ok?(await f.json()).tracks.map(s=>{var m,d;return{id:`spotify:${s.id}`,title:s.name,artist:s.artists.map(w=>w.name).join(", "),artists:s.artists.map(w=>w.name),album:s.album.name,cover_url:(m=s.album.images[0])==null?void 0:m.url,artwork_url:(d=s.album.images[0])==null?void 0:d.url,duration_ms:s.duration_ms,spotify_id:s.id,provider:"spotify",external_id:s.id}}):[]}catch(i){return console.error("Error fetching recommendations:",i),[]}}function T(){const{user:e}=y();return h({queryKey:["spotify-connected",e==null?void 0:e.id],queryFn:()=>A(e.id),enabled:!!e,staleTime:5*60*1e3})}function x(e=20){const{user:t}=y();return h({queryKey:["spotify-recently-played",t==null?void 0:t.id,e],queryFn:()=>$(t.id,e),enabled:!!t,staleTime:2*60*1e3,refetchOnWindowFocus:!0})}function z(){const{user:e}=y();return h({queryKey:["spotify-profile",e==null?void 0:e.id],queryFn:()=>j(e.id),enabled:!!e,staleTime:10*60*1e3})}function K(e="medium_term",t=20){const{user:r}=y(),{data:n}=T();return h({queryKey:["spotify-top-tracks",r==null?void 0:r.id,e,t],queryFn:()=>b(r.id,e,t),enabled:!!r&&n===!0,staleTime:10*60*1e3})}function M(e="medium_term",t=20){const{user:r}=y(),{data:n}=T();return h({queryKey:["spotify-top-artists",r==null?void 0:r.id,e,t],queryFn:()=>S(r.id,e,t),enabled:!!r&&n===!0,staleTime:10*60*1e3})}function R(){const{user:e}=y(),{data:t}=T();return h({queryKey:["music-stats",e==null?void 0:e.id],queryFn:()=>P(e.id),enabled:!!e&&t===!0,staleTime:30*60*1e3})}function U(e=[],t=[],r=20){const{user:n}=y(),{data:a}=T();return h({queryKey:["spotify-recommendations",n==null?void 0:n.id,e,t,r],queryFn:()=>E(n.id,e,t,r),enabled:!!n&&a===!0,staleTime:15*60*1e3})}export{z as a,K as b,M as c,x as d,R as e,U as f,C as n,T as u};
