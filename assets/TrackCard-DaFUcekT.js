import{c as A,j as e,m as f,M as le,a as S,g as F,h as X,s as N,r as g,u as Z,ap as G,aq as J,ar as ee,as as se,at as te,B as _,S as de,f as ce,k as me,b as ae,P as ie,i as q,au as ue,av as he,a1 as xe,X as pe}from"./index-CeBvdGEW.js";import{C as fe}from"./ChordBadge-C3RfY4d-.js";import{K as ye,R as ge}from"./rotate-ccw-D4EF5K_E.js";import{D as be,a as je,E as we,b as ve,c as P,d as B,T as Ne}from"./TrackComments-5Im5mESR.js";import{A as _e,a as Ce,b as Se}from"./avatar-CCUMLOo3.js";import{S as Me}from"./switch-DtxxtOjn.js";import{S as ke,b as Pe}from"./useFollowing-r7YbbFv8.js";import{L as H}from"./label-DHW6tThS.js";import{u as V}from"./useMutation-BDgd-EOW.js";import{U as E}from"./users-DLrylazx.js";import{A as O}from"./index-DFQEX0L-.js";import{M as R}from"./map-pin-8GOuCxqQ.js";import{R as Ae}from"./radio-QrXzeaWi.js";import{f as Te}from"./formatDistanceToNow-3UBXKcFR.js";import{S as U}from"./share-2-BJP1Wrve.js";import{C as Ie}from"./check-DOkHSHr-.js";import{T as qe}from"./twitter-xn4NetSt.js";import{M as ze,S as $e}from"./send-bW9eGos3.js";import{Q as Re}from"./QuickStreamButtons-Biy_1vOt.js";import{a as W}from"./timeFormat-BXo_t6_Q.js";import{U as De}from"./BottomNav-CYV2yjcU.js";import{M as Le}from"./music-2-Bb8nhiq2.js";import{A as Ee}from"./CladeIcon-C0sGXCqx.js";import{S as Ue}from"./sparkles-DNVEt6sE.js";import{H as Oe}from"./heart-Bhuj_Rs_.js";import{W as Fe}from"./waves-BM6CikAW.js";import{B as Ve}from"./bookmark-Doo6Vga1.js";import{M as Ke}from"./search-DPVAO1Be.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qe=A("Album",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["polyline",{points:"11 3 11 11 14 8 17 11 17 3",key:"1wcwz3"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Be=A("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ne=A("Link2",[["path",{d:"M9 17H7A5 5 0 0 1 7 7h2",key:"8i5ue5"}],["path",{d:"M15 7h2a5 5 0 1 1 0 10h-2",key:"1b9ql8"}],["line",{x1:"8",x2:"16",y1:"12",y2:"12",key:"1jonct"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const He=A("Settings2",[["path",{d:"M20 7h-9",key:"3s1dr2"}],["path",{d:"M14 17H5",key:"gfn3mx"}],["circle",{cx:"17",cy:"17",r:"3",key:"18b49y"}],["circle",{cx:"7",cy:"7",r:"3",key:"dfmy0x"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const We=A("SquarePlay",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"m9 8 6 4-6 4Z",key:"f1r3lt"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ye=A("Youtube",[["path",{d:"M2.5 17a24.12 24.12 0 0 1 0-10 2 2 0 0 1 1.4-1.4 49.56 49.56 0 0 1 16.2 0A2 2 0 0 1 21.5 7a24.12 24.12 0 0 1 0 10 2 2 0 0 1-1.4 1.4 49.55 49.55 0 0 1-16.2 0A2 2 0 0 1 2.5 17",key:"1q2vi4"}],["path",{d:"m10 15 5-3-5-3z",key:"1jp15x"}]]);function Xe({progression:s,detectedKey:t,detectedMode:a,cadenceType:i,confidenceScore:d,matchReason:x}){return e.jsxs(f.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"glass-strong rounded-2xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(ye,{className:"w-4 h-4"}),e.jsxs("span",{className:"text-sm font-medium",children:[t||"Unknown"," ",a&&a!=="unknown"?a:""]})]}),i&&i!=="none"&&e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-muted-foreground",children:[e.jsx(ge,{className:"w-3 h-3"}),e.jsx("span",{className:"capitalize",children:i})]})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(le,{className:"w-4 h-4 text-primary shrink-0"}),e.jsx("div",{className:"flex flex-wrap gap-1.5",children:s.map((m,l)=>e.jsx(f.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},transition:{delay:l*.05},children:e.jsx(fe,{chord:m,size:"md",keySignature:t})},l))})]}),x&&e.jsx("p",{className:"text-xs text-muted-foreground leading-relaxed pt-1 border-t border-border/50",children:x}),d!==void 0&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex-1 h-1 bg-muted rounded-full overflow-hidden",children:e.jsx(f.div,{initial:{width:0},animate:{width:`${d*100}%`},transition:{delay:.3,duration:.5},className:"h-full bg-gradient-to-r from-primary to-accent rounded-full"})}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[Math.round(d*100),"%"]})]})]})}function Y(s,t,a,i){const x=(a-s)*Math.PI/180,m=(i-t)*Math.PI/180,l=Math.sin(x/2)*Math.sin(x/2)+Math.cos(s*Math.PI/180)*Math.cos(a*Math.PI/180)*Math.sin(m/2)*Math.sin(m/2);return 6371*(2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l)))}function re(){const{user:s}=S(),t=typeof window<"u"&&window.location.hostname.endsWith("github.io");return F({queryKey:["user-location",s==null?void 0:s.id],queryFn:async()=>{if(!s||t)return null;const{data:a,error:i}=await N.from("user_locations").select("*").eq("user_id",s.id).maybeSingle();if(i)throw i;return a},enabled:!!s&&!t})}function Ze(){const s=X(),{user:t}=S();return V({mutationFn:async({latitude:a,longitude:i,sharingEnabled:d=!0,radiusKm:x=50})=>{if(!t)throw new Error("Must be logged in");const{data:m,error:l}=await N.from("user_locations").upsert({user_id:t.id,latitude:a,longitude:i,sharing_enabled:d,radius_km:x}).select().single();if(l)throw l;return m},onSuccess:()=>{s.invalidateQueries({queryKey:["user-location"]}),s.invalidateQueries({queryKey:["nearby-listeners"]})}})}function Ge(){const s=X(),{user:t}=S();return V({mutationFn:async()=>{if(!t)throw new Error("Must be logged in");const{error:a}=await N.from("user_locations").update({sharing_enabled:!1}).eq("user_id",t.id);if(a)throw a},onSuccess:()=>{s.invalidateQueries({queryKey:["user-location"]})}})}function Je(s,t){const{user:a}=S(),{data:i}=re();return F({queryKey:["nearby-listeners",s,t,i==null?void 0:i.latitude,i==null?void 0:i.longitude],queryFn:async()=>{if(!a||!(i!=null&&i.sharing_enabled))return[];const{data:d,error:x}=await N.from("user_locations").select("user_id, latitude_fuzzy, longitude_fuzzy").eq("sharing_enabled",!0).neq("user_id",a.id);if(x)throw x;const m=(d||[]).filter(r=>Y(i.latitude,i.longitude,Number(r.latitude_fuzzy),Number(r.longitude_fuzzy))<=i.radius_km).map(r=>({user_id:r.user_id,distance_km:Y(i.latitude,i.longitude,Number(r.latitude_fuzzy),Number(r.longitude_fuzzy))}));if(m.length===0)return[];const{data:l,error:h}=await N.from("profiles").select("id, display_name, avatar_url").in("id",m.map(r=>r.user_id));if(h)throw h;let b=[];if(s||t){let r=N.from("nearby_activity").select("*").in("user_id",m.map(n=>n.user_id)).order("listened_at",{ascending:!1});if(s&&(r=r.eq("track_id",s)),t){const n=t.replace(/[%_]/g,"\\$&");r=r.ilike("artist",`%${n}%`)}const{data:o}=await r;b=o||[]}return m.map(({user_id:r,distance_km:o})=>{const n=(l||[]).find(y=>y.id===r),u=b.find(y=>y.user_id===r);return{user_id:r,display_name:(n==null?void 0:n.display_name)||"Anonymous",avatar_url:n==null?void 0:n.avatar_url,distance_km:Math.round(o*10)/10,last_track:u==null?void 0:u.track_id,last_artist:u==null?void 0:u.artist,listened_at:u==null?void 0:u.listened_at}}).filter(r=>!s&&!t?!0:b.some(o=>o.user_id===r.user_id)).sort((r,o)=>r.distance_km-o.distance_km)},enabled:!!a&&!!(i!=null&&i.sharing_enabled)})}function es(){const{user:s}=S();return V({mutationFn:async({trackId:t,artist:a})=>{if(!s)return;const{error:i}=await N.from("nearby_activity").insert({user_id:s.id,track_id:t,artist:a||null});if(i)throw i}})}function ss({trackId:s,artist:t,trackTitle:a}){const[i,d]=g.useState(!1),[x,m]=g.useState(!1),[l,h]=g.useState(50),[b,j]=g.useState(!1),{user:r}=S(),o=Z(),{data:n,isLoading:u}=re(),{data:y=[],isLoading:C}=Je(s,t),w=Ze(),z=Ge();g.useEffect(()=>{n!=null&&n.radius_km&&h(n.radius_km)},[n==null?void 0:n.radius_km]);const $=async()=>{if(!r){o("/auth");return}j(!0);try{const c=await new Promise((v,k)=>{navigator.geolocation.getCurrentPosition(v,k,{enableHighAccuracy:!1,timeout:1e4,maximumAge:3e5})});await w.mutateAsync({latitude:c.coords.latitude,longitude:c.coords.longitude,sharingEnabled:!0,radiusKm:l})}catch(c){console.error("Location error:",c)}finally{j(!1)}},D=async c=>{const v=c[0];h(v),n&&await w.mutateAsync({latitude:n.latitude,longitude:n.longitude,sharingEnabled:!0,radiusKm:v})},L=async c=>{c&&!n?await $():c?n&&await w.mutateAsync({latitude:n.latitude,longitude:n.longitude,sharingEnabled:c,radiusKm:l}):await z.mutateAsync()},M=(n==null?void 0:n.sharing_enabled)??!1;return e.jsxs(G,{open:i,onOpenChange:d,children:[e.jsx(J,{asChild:!0,children:e.jsxs(f.button,{whileTap:{scale:.9},className:"flex flex-col items-center gap-1 p-3 rounded-xl transition-all text-muted-foreground hover:text-foreground",children:[e.jsxs("div",{className:"p-3 rounded-full bg-muted/50 hover:bg-muted transition-all relative",children:[e.jsx(E,{className:"w-6 h-6"}),M&&y.length>0&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-accent text-accent-foreground text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center",children:y.length})]}),e.jsx("span",{className:"text-xs font-medium",children:"Nearby"})]})}),e.jsxs(ee,{side:"bottom",className:"h-[80vh] rounded-t-3xl",children:[e.jsx(se,{className:"pb-4 border-b border-border",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(te,{className:"flex items-center gap-2",children:[e.jsx(E,{className:"w-5 h-5 text-accent"}),a?`Listeners of "${a}"`:"Nearby Music Lovers"]}),e.jsx(_,{variant:"ghost",size:"icon",onClick:()=>m(!x),className:"h-8 w-8",children:e.jsx(He,{className:"w-4 h-4"})})]})}),e.jsx(O,{children:x&&e.jsx(f.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},className:"overflow-hidden border-b border-border",children:e.jsxs("div",{className:"py-4 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(R,{className:"w-4 h-4 text-primary"}),e.jsx(H,{htmlFor:"location-sharing",children:"Share my location"})]}),e.jsx(Me,{id:"location-sharing",checked:M,onCheckedChange:L,disabled:w.isPending||z.isPending})]}),M&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(H,{children:"Discovery radius"}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[l," km"]})]}),e.jsx(ke,{value:[l],onValueChange:D,min:5,max:100,step:5,className:"w-full"})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Your location is only visible to others who also share theirs."})]})})}),e.jsx("div",{className:"flex flex-col h-[calc(80vh-10rem)]",children:e.jsx(de,{className:"flex-1 py-4",children:r?M?C||u?e.jsx("div",{className:"space-y-4",children:[1,2,3].map(c=>e.jsxs("div",{className:"flex gap-3 animate-pulse",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-muted"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("div",{className:"h-4 w-32 bg-muted rounded"}),e.jsx("div",{className:"h-3 w-24 bg-muted rounded"})]})]},c))}):y.length===0?e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(Ae,{className:"w-12 h-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"No listeners nearby yet"}),e.jsx("p",{className:"text-sm",children:"Check back later or expand your radius"})]}):e.jsx(O,{mode:"popLayout",children:y.map((c,v)=>{var k;return e.jsxs(f.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:v*.05},className:"flex gap-3 mb-4 p-3 rounded-xl glass hover:bg-muted/30 transition-colors",children:[e.jsxs(_e,{className:"w-12 h-12",children:[e.jsx(Ce,{src:c.avatar_url}),e.jsx(Se,{className:"bg-accent/20 text-accent",children:((k=c.display_name)==null?void 0:k.charAt(0).toUpperCase())||"A"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:c.display_name}),e.jsxs("span",{className:"text-xs text-muted-foreground flex items-center gap-1",children:[e.jsx(R,{className:"w-3 h-3"}),c.distance_km," km"]})]}),c.last_artist&&e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:["Recently listened to ",c.last_artist]}),c.listened_at&&e.jsx("p",{className:"text-xs text-muted-foreground",children:Te(new Date(c.listened_at),{addSuffix:!0})})]})]},c.user_id)})}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(R,{className:"w-12 h-12 mx-auto mb-3 text-muted-foreground opacity-50"}),e.jsx("p",{className:"text-muted-foreground mb-2",children:"Enable location sharing"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Discover people nearby who love the same music"}),e.jsxs(_,{onClick:$,disabled:b,className:"gap-2",children:[b?e.jsx(ce,{className:"w-4 h-4 animate-spin"}):e.jsx(R,{className:"w-4 h-4"}),"Enable Location"]})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(E,{className:"w-12 h-12 mx-auto mb-3 text-muted-foreground opacity-50"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Sign in to discover nearby listeners"}),e.jsx(_,{onClick:()=>o("/auth"),children:"Sign In"})]})})})]})]})}function ts({track:s,onShare:t}){const[a,i]=g.useState(!1),[d,x]=g.useState(!1),{toast:m}=me(),l=`${window.location.origin}/track/${s.id}`,h=`Check out "${s.title}" by ${s.artist} on HarmonyFeed! ðŸŽµ`,b=async()=>{try{await navigator.clipboard.writeText(l),x(!0),m({title:"Link copied!"}),setTimeout(()=>x(!1),2e3),t==null||t()}catch{m({title:"Failed to copy",variant:"destructive"})}},j=async()=>{if(navigator.share)try{await navigator.share({title:s.title,text:h,url:l}),t==null||t(),i(!1)}catch{}},r=[{name:"Copy Link",icon:d?Ie:Be,onClick:b,className:d?"text-green-500":""},{name:"Twitter/X",icon:qe,onClick:()=>{window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(h)}&url=${encodeURIComponent(l)}`,"_blank"),t==null||t()}},{name:"WhatsApp",icon:ze,onClick:()=>{window.open(`https://wa.me/?text=${encodeURIComponent(h+" "+l)}`,"_blank"),t==null||t()}},{name:"Telegram",icon:$e,onClick:()=>{window.open(`https://t.me/share/url?url=${encodeURIComponent(l)}&text=${encodeURIComponent(h)}`,"_blank"),t==null||t()}}];return e.jsxs(G,{open:a,onOpenChange:i,children:[e.jsx(J,{asChild:!0,children:e.jsxs(_,{variant:"ghost",size:"sm",className:"text-muted-foreground hover:text-foreground gap-2",children:[e.jsx(U,{className:"w-4 h-4"}),"Share"]})}),e.jsxs(ee,{side:"bottom",className:"rounded-t-3xl",children:[e.jsx(se,{className:"pb-4",children:e.jsxs(te,{className:"flex items-center gap-2",children:[e.jsx(U,{className:"w-5 h-5 text-primary"}),'Share "',s.title,'"']})}),e.jsxs("div",{className:"space-y-4 pb-8",children:[e.jsxs("div",{className:"flex gap-3 p-3 rounded-xl glass",children:[s.cover_url?e.jsx("img",{src:s.cover_url,alt:"",className:"w-16 h-16 rounded-lg object-cover"}):e.jsx("div",{className:"w-16 h-16 rounded-lg bg-muted flex items-center justify-center",children:e.jsx(ne,{className:"w-6 h-6 text-muted-foreground"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-medium truncate",children:s.title}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:s.artist})]})]}),typeof navigator<"u"&&"share"in navigator&&e.jsxs(_,{onClick:j,className:"w-full gap-2",variant:"default",children:[e.jsx(U,{className:"w-4 h-4"}),"Share"]}),e.jsx("div",{className:"grid grid-cols-4 gap-3",children:r.map(o=>e.jsxs(f.button,{whileTap:{scale:.95},onClick:o.onClick,className:"flex flex-col items-center gap-2 p-3 rounded-xl hover:bg-muted/50 transition-colors",children:[e.jsx("div",{className:`p-3 rounded-full bg-muted ${o.className||""}`,children:e.jsx(o.icon,{className:"w-5 h-5"})}),e.jsx("span",{className:"text-xs text-muted-foreground",children:o.name})]},o.name))})]})]})]})}const as={intro:"bg-blue-500/20 text-blue-300 border-blue-500/30",verse:"bg-purple-500/20 text-purple-300 border-purple-500/30","pre-chorus":"bg-pink-500/20 text-pink-300 border-pink-500/30",chorus:"bg-green-500/20 text-green-300 border-green-500/30",bridge:"bg-orange-500/20 text-orange-300 border-orange-500/30",outro:"bg-red-500/20 text-red-300 border-red-500/30",breakdown:"bg-yellow-500/20 text-yellow-300 border-yellow-500/30",drop:"bg-cyan-500/20 text-cyan-300 border-cyan-500/30"};function is({sections:s,youtubeId:t,spotifyId:a,trackTitle:i,trackArtist:d,canonicalTrackId:x=null,className:m}){const{openPlayer:l,seekTo:h,youtubeOpen:b,youtubeTrackId:j,spotifyOpen:r,spotifyTrackId:o}=ae(),n=u=>{const y=Math.floor(u.start_ms/1e3),C=b&&(j==null?void 0:j.includes(t||""));t?C?h(y):l({canonicalTrackId:null,provider:"youtube",providerTrackId:t,autoplay:!0,startSec:y}):a&&!(r&&o===a)&&l({canonicalTrackId:null,provider:"spotify",providerTrackId:a,autoplay:!0})};return!s||s.length===0?null:e.jsx("div",{className:q("flex gap-1.5 flex-wrap",m),children:s.map((u,y)=>{const C=as[u.label]||"bg-muted/20 text-muted-foreground border-muted/30";return e.jsx(f.button,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},transition:{delay:y*.03},onClick:()=>n(u),className:q("group relative px-2 py-1 rounded-md text-xs font-medium","border transition-all hover:scale-105",C),title:`Play from ${u.label} at ${W(u.start_ms)}`,children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ie,{className:"w-2.5 h-2.5 opacity-0 group-hover:opacity-100 transition-opacity"}),e.jsx("span",{className:"capitalize",children:u.label}),e.jsx("span",{className:"text-[10px] opacity-60",children:W(u.start_ms)})]})},u.id)})})}function ns({track:s}){const t=Z(),{playNext:a,playLater:i}=ue(),d=()=>{s.album&&t(`/album/${encodeURIComponent(s.album)}`)},x=()=>{s.artist&&t(`/artist/${encodeURIComponent(s.artist)}`)},m=()=>{if(s.progression_roman){const h=s.progression_roman.join("-");t(`/search?mode=chord&q=${encodeURIComponent(h)}`)}},l=()=>{t(`/connections/${encodeURIComponent(s.id)}`)};return e.jsxs(be,{children:[e.jsx(je,{asChild:!0,children:e.jsx(_,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:h=>h.stopPropagation(),children:e.jsx(we,{className:"w-4 h-4"})})}),e.jsxs(ve,{align:"end",className:"w-56",children:[e.jsxs(P,{onClick:()=>a(s),children:[e.jsx(We,{className:"w-4 h-4 mr-2"}),"Play Next"]}),e.jsxs(P,{onClick:()=>i(s),children:[e.jsx(he,{className:"w-4 h-4 mr-2"}),"Add to Queue"]}),e.jsx(B,{}),s.album&&e.jsxs(P,{onClick:d,children:[e.jsx(Qe,{className:"w-4 h-4 mr-2"}),"View Album"]}),s.artist&&e.jsxs(P,{onClick:x,children:[e.jsx(De,{className:"w-4 h-4 mr-2"}),"View Artist"]}),e.jsx(B,{}),s.progression_roman&&s.progression_roman.length>0&&e.jsxs(P,{onClick:m,children:[e.jsx(Le,{className:"w-4 h-4 mr-2"}),"Similar Chord Progressions"]}),e.jsxs(P,{onClick:l,children:[e.jsx(ne,{className:"w-4 h-4 mr-2"}),"View Samples & Connections"]})]})]})}function rs(s){return F({queryKey:["track-comments",s],queryFn:async()=>{try{const{data:t,error:a}=await N.from("track_comments").select("*").eq("track_id",s).order("created_at",{ascending:!0});return a?(console.warn("[Comments] track_comments fetch skipped due to schema error",a),[]):(t||[]).map(i=>({...i,user_display_name:"Anonymous",user_avatar_url:void 0}))}catch(t){return console.error("Failed to load track comments:",t),[]}},enabled:!!s})}function $s({track:s,isActive:t,onInteraction:a,interactions:i=new Set,onPipModeActivate:d,isPipActive:x=!1}){const{user:m,guestMode:l}=S(),[h,b]=g.useState(!1),[j,r]=g.useState(!1),o=g.useRef(null),n=g.useRef(null),u=es(),y=Pe(),{openPlayer:C}=ae(),{data:w}=rs(s.id),z=(w==null?void 0:w.length)||0,$=g.useCallback(p=>p.map((T,K)=>{var Q;return{id:`${s.id}-${T.type}-${K}`,track_id:s.id,label:T.type,start_ms:T.start_time*1e3,end_ms:T.end_time?T.end_time*1e3:(((Q=p[K+1])==null?void 0:Q.start_time)||s.duration_ms||24e4/1e3)*1e3,created_at:new Date().toISOString()}}),[s.id,s.duration_ms]),D=g.useCallback(()=>{const p=s.duration_ms||24e4;return[{id:`${s.id}-intro`,track_id:s.id,label:"intro",start_ms:0,end_ms:Math.floor(p*.1),created_at:new Date().toISOString()},{id:`${s.id}-verse1`,track_id:s.id,label:"verse",start_ms:Math.floor(p*.1),end_ms:Math.floor(p*.3),created_at:new Date().toISOString()},{id:`${s.id}-chorus1`,track_id:s.id,label:"chorus",start_ms:Math.floor(p*.3),end_ms:Math.floor(p*.5),created_at:new Date().toISOString()},{id:`${s.id}-verse2`,track_id:s.id,label:"verse",start_ms:Math.floor(p*.5),end_ms:Math.floor(p*.65),created_at:new Date().toISOString()},{id:`${s.id}-chorus2`,track_id:s.id,label:"chorus",start_ms:Math.floor(p*.65),end_ms:Math.floor(p*.85),created_at:new Date().toISOString()},{id:`${s.id}-outro`,track_id:s.id,label:"outro",start_ms:Math.floor(p*.85),end_ms:p,created_at:new Date().toISOString()}]},[s.id,s.duration_ms]),L=s.sections&&s.sections.length>0?$(s.sections):D();g.useEffect(()=>{!t&&h&&c()},[t]),g.useEffect(()=>()=>{o.current&&o.current.pause()},[]);const M=g.useCallback(async()=>{if(o.current&&s.preview_url)try{await o.current.play(),b(!0),n.current=Date.now(),u.mutate({trackId:s.id,artist:s.artist})}catch(p){console.error("Playback failed:",p)}},[s.preview_url,s.id,s.artist,u]),c=g.useCallback(()=>{if(o.current&&(o.current.pause(),b(!1),n.current&&m)){const p=Date.now()-n.current;y.mutate({trackId:s.id,durationMs:p,source:"feed"}),n.current=null}},[m,s.id,y]),v=()=>{h?c():M()},k=()=>{if(b(!1),n.current&&m){const p=Date.now()-n.current;y.mutate({trackId:s.id,durationMs:p,source:"feed"}),n.current=null}},oe=()=>{a("share")};return e.jsxs(f.div,{initial:{opacity:0},animate:{opacity:t?1:.5},className:"relative w-full h-full flex flex-col","data-track-card":s.id,children:[s.preview_url&&e.jsx("audio",{ref:o,src:s.preview_url,preload:"none",onEnded:k}),e.jsx("div",{className:"absolute inset-0 z-0",children:s.cover_url?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:s.cover_url,alt:"",className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-background via-background/80 to-background/40"})]}):e.jsx("div",{className:"w-full h-full bg-gradient-to-br from-secondary to-background"})}),e.jsxs("div",{className:"relative z-10 flex-1 flex flex-col justify-end p-6 pb-8 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs(f.h2,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},className:"text-2xl font-bold text-foreground line-clamp-2 flex-1 flex items-center gap-2",children:[e.jsx("span",{children:s.title}),s.is_common_ancestor&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-gradient-to-r from-amber-500/20 to-orange-500/20 border border-amber-500/30",title:"Common Ancestor - Foundational track that influenced a musical movement",children:[e.jsx(Ee,{size:14,className:"text-amber-400"}),e.jsx("span",{className:"text-[10px] font-semibold text-amber-400 uppercase tracking-wide",children:"Ancestor"})]})]}),e.jsx(ns,{track:s})]}),e.jsx(f.p,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.05},className:"text-lg text-muted-foreground",children:s.artist}),(s.tempo||s.genre)&&e.jsxs(f.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.07},className:"flex items-center gap-2 text-sm text-muted-foreground",children:[s.tempo&&e.jsxs("span",{className:"font-medium",children:[Math.round(s.tempo)," BPM"]}),s.tempo&&s.genre&&e.jsx("span",{children:"â€¢"}),s.genre&&e.jsx("span",{className:"capitalize",children:s.genre})]})]}),e.jsx(f.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.08},children:e.jsx(is,{sections:L,youtubeId:s.youtube_id,spotifyId:s.spotify_id,trackTitle:s.title,trackArtist:s.artist||"",canonicalTrackId:s.id})}),e.jsxs(f.div,{initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},transition:{delay:.1},className:"flex items-center gap-3",children:[s.preview_url&&e.jsxs(_,{variant:"outline",size:"lg",onClick:v,className:"gap-2 glass border-white/20 hover:bg-white/10",children:[h?e.jsx(xe,{className:"w-5 h-5"}):e.jsx(ie,{className:"w-5 h-5"}),h?"Pause":"Preview"]}),s.youtube_id&&e.jsxs(_,{variant:"outline",size:"lg",onClick:()=>C({canonicalTrackId:s.id,provider:"youtube",providerTrackId:s.youtube_id,autoplay:!0,context:"feed-card-watch",title:s.title,artist:s.artist}),className:"gap-2 glass border-white/20 hover:bg-white/10",children:[e.jsx(Ye,{className:"w-5 h-5"}),"Watch"]}),e.jsx(Re,{track:{spotifyId:s.spotify_id||void 0,youtubeId:s.youtube_id||void 0,urlSpotifyWeb:s.url_spotify_web||void 0,urlSpotifyApp:s.url_spotify_app||void 0,urlYoutube:s.url_youtube||void 0},canonicalTrackId:s.id,trackTitle:s.title,trackArtist:s.artist,size:"md"})]}),s.progression_roman&&s.progression_roman.length>0&&e.jsx(f.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.15},children:e.jsx(Xe,{progression:s.progression_roman,detectedKey:s.detected_key,detectedMode:s.detected_mode,cadenceType:s.cadence_type,confidenceScore:s.confidence_score,matchReason:"Same viâ€“IVâ€“Iâ€“V loop with similar energy"})}),e.jsxs(f.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.2},className:"flex items-center justify-between pt-4 relative z-20",children:[e.jsx(I,{icon:pe,label:"Skip",isActive:i.has("skip"),onClick:()=>a("skip"),variant:"muted"}),e.jsx(I,{icon:Ue,label:"Harmonic",isActive:i.has("more_harmonic"),onClick:()=>a("more_harmonic"),variant:"primary"}),e.jsx(I,{icon:Oe,label:"Like",isActive:i.has("like"),onClick:()=>a("like"),variant:"accent"}),e.jsx(I,{icon:Fe,label:"Vibe",isActive:i.has("more_vibe"),onClick:()=>a("more_vibe"),variant:"primary"}),e.jsx(I,{icon:Ve,label:"Save",isActive:i.has("save"),onClick:()=>a("save"),variant:"muted"})]}),e.jsxs(f.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.25},className:"flex items-center justify-center gap-4",children:[e.jsxs(f.button,{whileTap:{scale:.9},onClick:()=>r(!j),className:"flex items-center gap-2 px-4 py-2 rounded-full bg-muted/50 hover:bg-muted transition-all text-muted-foreground hover:text-foreground",children:[e.jsx(Ke,{className:"w-5 h-5"}),e.jsx("span",{className:"text-sm font-medium",children:z})]}),e.jsx(ss,{trackId:s.id,artist:s.artist,trackTitle:s.title}),e.jsx(ts,{track:s,onShare:oe})]}),e.jsx(O,{children:j&&e.jsx(f.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:.3},className:"overflow-hidden",children:e.jsx("div",{className:"mt-6 pt-6 border-t border-border/50",children:e.jsx(Ne,{trackId:s.id})})})})]})]})}function I({icon:s,label:t,isActive:a,onClick:i,variant:d}){return e.jsxs(f.button,{whileTap:{scale:.9},onClick:i,className:q("flex flex-col items-center gap-1 p-3 rounded-xl transition-all",a&&d==="accent"&&"text-accent glow-accent",a&&d==="primary"&&"text-primary glow-primary",a&&d==="muted"&&"text-foreground",!a&&"text-muted-foreground hover:text-foreground"),children:[e.jsx("div",{className:q("p-3 rounded-full transition-all",a&&d==="accent"&&"bg-accent/20",a&&d==="primary"&&"bg-primary/20",a&&d==="muted"&&"bg-muted",!a&&"bg-muted/50 hover:bg-muted"),children:e.jsx(s,{className:q("w-6 h-6",a&&d==="accent"&&"fill-current")})}),e.jsx("span",{className:"text-xs font-medium",children:t})]})}export{$s as T};
