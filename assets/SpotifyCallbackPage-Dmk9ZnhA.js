import{aa as E,u as P,a as R,r as u,j as e,L as T,B as w,h as O}from"./index-Cs3svTVr.js";import{g as A,c as b}from"./useSpotifyConnect-CObq8WSL.js";import{C as U}from"./circle-check-B6bisTBW.js";import{C as z}from"./circle-alert-y38KiAD3.js";import"./useMutation-Dj6Kpndn.js";const F="https://accounts.spotify.com/api/token";function Y(){const[t]=E(),a=P(),{user:n}=R(),[c,h]=u.useState("loading"),[k,j]=u.useState("");return u.useEffect(()=>{async function C(){var g;try{console.log("[Spotify Callback] Starting..."),console.log("[Spotify Callback] URL params:",Object.fromEntries(t.entries()));const o=t.get("code"),s=t.get("state"),l=t.get("error"),m=t.get("error_description");if(l)throw console.error("[Spotify Callback] Spotify error:",l,m),new Error(m||`Spotify authorization failed: ${l}`);if(!o||!s)throw console.error("[Spotify Callback] Missing code or state"),new Error("Missing authorization code or state");const r=A();if(console.log("[Spotify Callback] Stored state:",((g=r==null?void 0:r.state)==null?void 0:g.substring(0,8))+"..."),console.log("[Spotify Callback] Received state:",(s==null?void 0:s.substring(0,8))+"..."),!r||r.state!==s)throw console.error("[Spotify Callback] State mismatch"),new Error("Invalid state parameter. Please try connecting again.");if(!n)throw console.error("[Spotify Callback] No user logged in"),new Error("You must be logged in to connect Spotify");console.log("[Spotify Callback] Exchanging code for tokens...");const v="b1d936a5b2bd4cb199d3ede9a4fa2449",d="/cladeai/",I=d.endsWith("/")?d:`${d}/`,x="https://repoisrael.github.io/cladeai/spotify-callback";console.log("[Spotify Callback] Using redirect URI:",x);const f=await fetch(F,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"authorization_code",code:o,redirect_uri:x,client_id:v,code_verifier:r.codeVerifier})});if(!f.ok){const p=await f.json();throw console.error("[Spotify Callback] Token exchange failed:",p),new Error(p.error_description||`Token exchange failed: ${p.error}`)}console.log("[Spotify Callback] Token exchange successful");const i=await f.json();console.log("[Spotify Callback] Fetching Spotify profile...");const y=await fetch("https://api.spotify.com/v1/me",{headers:{Authorization:`Bearer ${i.access_token}`}});if(!y.ok)throw new Error("Failed to fetch Spotify profile");const _=await y.json(),N=new Date(Date.now()+i.expires_in*1e3).toISOString(),{error:S}=await O.from("user_providers").upsert({user_id:n.id,provider:"spotify",provider_user_id:_.id,access_token:i.access_token,refresh_token:i.refresh_token,expires_at:N,connected_at:new Date().toISOString()},{onConflict:"user_id,provider"});if(S)throw console.error("Failed to store Spotify connection:",S),new Error("Failed to save Spotify connection");b(),h("success"),setTimeout(()=>{a("/profile",{replace:!0})},2e3)}catch(o){console.error("Spotify callback error:",o),j(o instanceof Error?o.message:"Unknown error"),h("error"),b()}}C()},[t,n,a]),e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs("div",{className:"max-w-md w-full text-center",children:[c==="loading"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx(T,{size:"lg"}),e.jsx("h2",{className:"text-xl font-semibold",children:"Connecting to Spotify..."}),e.jsx("p",{className:"text-muted-foreground",children:"Please wait while we complete the connection"})]}),c==="success"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-green-500/20 flex items-center justify-center mx-auto",children:e.jsx(U,{className:"w-8 h-8 text-green-500"})}),e.jsx("h2",{className:"text-xl font-semibold text-green-500",children:"Spotify Connected!"}),e.jsx("p",{className:"text-muted-foreground",children:"Redirecting to your profile..."})]}),c==="error"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-destructive/20 flex items-center justify-center mx-auto",children:e.jsx(z,{className:"w-8 h-8 text-destructive"})}),e.jsx("h2",{className:"text-xl font-semibold text-destructive",children:"Connection Failed"}),e.jsx("p",{className:"text-muted-foreground",children:k}),e.jsxs("div",{className:"flex gap-2 justify-center mt-4",children:[e.jsx(w,{variant:"outline",onClick:()=>a("/profile"),children:"Go to Profile"}),e.jsx(w,{onClick:()=>a("/profile"),children:"Try Again"})]})]})]})})}export{Y as default};
