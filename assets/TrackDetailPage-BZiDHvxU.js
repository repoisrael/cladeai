import{c as K,r as d,j as e,m as y,s as Q,N as U,u as q,b as G,B as S,i as k,P as V}from"./index-BI6e5KKd.js";import{a as J,S as X}from"./useTracks-BbX10Uyx.js";import{B as Z}from"./BottomNav-DrspHnQU.js";import{C as L}from"./ChordBadge-CpdYEsQY.js";import{T as ee}from"./TrackLineageView-CZITbqsL.js";import{T as se}from"./TrackComments-CtkKmXdi.js";import{H as te}from"./heart-CutDkfLo.js";import{M as ae}from"./send-CyFpBjwX.js";import{S as re}from"./share-2-DOXsRuWz.js";import{Q as ie}from"./QuickStreamButtons-Bv0D4LiA.js";import{s as oe}from"./youtubeSearchService-C_W3FhdG.js";import{C as g}from"./card-CVttam_D.js";import{T as le,a as de,b as j,c as b}from"./tabs-Ci_46YDe.js";import{a as P,b as ne}from"./timeFormat-BXo_t6_Q.js";import{M as I}from"./music-2-B_Dssdoi.js";import{A as ce}from"./arrow-left-q0WbGlr1.js";import{E as me}from"./external-link-BhkerGxg.js";import"./index-_2dnxds6.js";import"./seedTracks-B22TRa5Y.js";import"./spotifySearchService-mwupN4jQ.js";import"./search-B6yafTIf.js";import"./badge-BU1YdHVn.js";import"./CladeIcon-dFdl9Xxq.js";import"./arrow-right-dZ6P8eRf.js";import"./sparkles-BmjmEley.js";import"./textarea-yoZM0u9c.js";import"./avatar-3tZON9LW.js";import"./index-BeP1845I.js";import"./Combination-CjLqDtlN.js";import"./index-D_raKJPF.js";import"./index-B9TUITdl.js";import"./chevron-right-CWmwnNKF.js";import"./check-ChXx28qk.js";import"./formatDistanceToNow-3UBXKcFR.js";import"./en-US-wfBU2YNu.js";import"./trash-2-xVWoPPMJ.js";import"./providers-CHelMshW.js";import"./music-kwvnLi8E.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xe=K("Info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]);function ue({trackId:n,likes:u=0,isLiked:s=!1,onLike:h,onComment:p,onShare:v}){const[c,T]=d.useState(s),[l,N]=d.useState(u),f=()=>{T(!c),N(c?l-1:l+1),h==null||h()};return e.jsxs("div",{className:"fixed right-3 top-1/2 -translate-y-1/2 z-40 flex flex-col gap-4 md:hidden transform",children:[e.jsxs(y.button,{whileTap:{scale:.9},onClick:f,className:"flex flex-col items-center gap-1","aria-label":c?"Unlike":"Like",children:[e.jsx("div",{className:"flex h-12 w-12 items-center justify-center rounded-full bg-background/80 backdrop-blur-xl border border-border/50 shadow-lg",children:e.jsx(te,{className:`h-6 w-6 transition-all ${c?"fill-red-500 text-red-500":"text-foreground"}`})}),l>0&&e.jsx("span",{className:"text-xs font-semibold text-foreground drop-shadow-lg",children:l>=1e3?`${(l/1e3).toFixed(1)}k`:l})]}),e.jsx(y.button,{whileTap:{scale:.9},onClick:p,className:"flex flex-col items-center gap-1","aria-label":"Comment",children:e.jsx("div",{className:"flex h-12 w-12 items-center justify-center rounded-full bg-background/80 backdrop-blur-xl border border-border/50 shadow-lg",children:e.jsx(ae,{className:"h-6 w-6 text-foreground"})})}),e.jsx(y.button,{whileTap:{scale:.9},onClick:v,className:"flex flex-col items-center gap-1","aria-label":"Share",children:e.jsx("div",{className:"flex h-12 w-12 items-center justify-center rounded-full bg-background/80 backdrop-blur-xl border border-border/50 shadow-lg",children:e.jsx(re,{className:"h-6 w-6 text-foreground"})})})]})}async function he(n){const{data:u,error:s}=await Q.rpc("get_track_sections",{p_track_id:n});return s?(console.debug("track_sections not available:",s.message),[]):u??[]}function ss(){const{trackId:n}=U(),u=q(),{data:s,isLoading:h}=J(decodeURIComponent(n||"")),{openPlayer:p,provider:v,trackId:c,isPlaying:T}=G(),l=0,[N,f]=d.useState([]),[_,$]=d.useState(null),[pe,z]=d.useState(null),[M,B]=d.useState([]),[O,C]=d.useState(!1),w=l*1e3,i=N.find(t=>w>=t.start_ms&&w<t.end_ms),F=(()=>{if(!(i!=null&&i.chords)||!(i!=null&&i.chord_timings))return-1;const t=w-i.start_ms;for(let a=i.chord_timings.length-1;a>=0;a--)if(t>=i.chord_timings[a])return a;return 0})();d.useEffect(()=>{s!=null&&s.id&&(async()=>(await E(),await H(),await Y(),await W()))()},[s==null?void 0:s.id]);async function W(){if(!(!(s!=null&&s.artist)||!(s!=null&&s.title))){C(!0);try{const a=(await oe(s.artist,s.title)).map(r=>({id:r.videoId,videoId:r.videoId,title:r.title,type:r.type}));B(a)}catch(t){console.error("Failed to load YouTube videos:",t)}finally{C(!1)}}}async function E(){if(s!=null&&s.id)try{const t=await he(s.id);f(t),t.length===0&&s.duration_ms&&f(D(s))}catch(t){console.error("Failed to load sections:",t),s.duration_ms&&f(D(s))}}async function H(){if(!(!(s!=null&&s.title)||!(s!=null&&s.artist)))try{s.progression_roman&&$({chords:s.progression_roman,key:s.detected_key,mode:s.detected_mode,source:"local"})}catch(t){console.error("Failed to load Hooktheory data:",t)}}async function Y(){if(!(!(s!=null&&s.title)||!(s!=null&&s.artist)))try{z({samples:[],sampledBy:[],covers:[],source:"local"})}catch(t){console.error("Failed to load WhoSampled data:",t)}}function D(t){const a=t.duration_ms||18e4,r=t.progression_roman||["I","V","vi","IV"];return[{id:`${t.id}-intro`,track_id:t.id,label:"intro",start_ms:0,end_ms:Math.floor(a*.08),created_at:new Date().toISOString(),chords:r.slice(0,2),chord_timings:[0,Math.floor(a*.04)]},{id:`${t.id}-verse1`,track_id:t.id,label:"verse",start_ms:Math.floor(a*.08),end_ms:Math.floor(a*.3),created_at:new Date().toISOString(),chords:r,chord_timings:r.map((x,o)=>Math.floor(a*.22*o/r.length))},{id:`${t.id}-chorus1`,track_id:t.id,label:"chorus",start_ms:Math.floor(a*.3),end_ms:Math.floor(a*.45),created_at:new Date().toISOString(),chords:r,chord_timings:r.map((x,o)=>Math.floor(a*.15*o/r.length))},{id:`${t.id}-verse2`,track_id:t.id,label:"verse",start_ms:Math.floor(a*.45),end_ms:Math.floor(a*.6),created_at:new Date().toISOString(),chords:r,chord_timings:r.map((x,o)=>Math.floor(a*.15*o/r.length))},{id:`${t.id}-chorus2`,track_id:t.id,label:"chorus",start_ms:Math.floor(a*.6),end_ms:Math.floor(a*.75),created_at:new Date().toISOString(),chords:r,chord_timings:r.map((x,o)=>Math.floor(a*.15*o/r.length))},{id:`${t.id}-bridge`,track_id:t.id,label:"bridge",start_ms:Math.floor(a*.75),end_ms:Math.floor(a*.85),created_at:new Date().toISOString(),chords:r.slice(0,2),chord_timings:[0,Math.floor(a*.05)]},{id:`${t.id}-outro`,track_id:t.id,label:"outro",start_ms:Math.floor(a*.85),end_ms:a,created_at:new Date().toISOString(),chords:r.slice(0,2),chord_timings:[0,Math.floor(a*.075)]}]}function A(t){const a=Math.floor(t.start_ms/1e3);s!=null&&s.youtube_id&&p({provider:"youtube",providerTrackId:s.youtube_id,canonicalTrackId:s.id,autoplay:!0,startSec:a,context:"section_navigation"})}function R(t){!(s!=null&&s.artist)||!(s!=null&&s.title)||p({canonicalTrackId:s.id,provider:"youtube",providerTrackId:t.videoId,autoplay:!0,context:"track-detail-video",title:s.title,artist:s.artist})}const m=M.length>0?M:s!=null&&s.youtube_id?[{id:"official",videoId:s.youtube_id,title:`${s.title} - Official`,type:"official"}]:[];return h||!s?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(I,{className:"w-12 h-12 text-muted-foreground animate-pulse mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading track..."})]})}):e.jsxs("div",{className:"min-h-screen bg-background pb-24",children:[e.jsx("header",{className:"sticky top-0 z-40 glass-strong safe-top",children:e.jsxs("div",{className:"flex items-center gap-3 px-4 py-3 max-w-4xl mx-auto",children:[e.jsx(S,{variant:"ghost",size:"icon",onClick:()=>u(-1),children:e.jsx(ce,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h1",{className:"text-lg font-bold truncate",children:s.title}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:s.artist})]})]})}),e.jsxs("main",{className:"px-4 py-6 max-w-4xl mx-auto space-y-6",children:[e.jsxs(y.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"flex gap-4",children:[s.cover_url&&e.jsx("img",{src:s.cover_url,alt:s.title,className:"w-32 h-32 rounded-lg object-cover flex-shrink-0 shadow-lg"}),e.jsxs("div",{className:"flex-1 space-y-3",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold",children:s.title}),e.jsx("p",{className:"text-lg text-muted-foreground",children:s.artist}),s.album&&e.jsx("p",{className:"text-sm text-muted-foreground",children:s.album})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3 text-sm",children:[s.detected_key&&e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"text-muted-foreground",children:"Key:"}),e.jsxs("span",{className:"font-medium",children:[s.detected_key," ",s.detected_mode]})]}),s.tempo&&e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"text-muted-foreground",children:"•"}),e.jsx("span",{className:"text-muted-foreground",children:"BPM:"}),e.jsx("span",{className:"font-medium",children:Math.round(s.tempo)})]}),s.genre&&e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"text-muted-foreground",children:"•"}),e.jsx("span",{className:"text-muted-foreground",children:"Genre:"}),e.jsx("span",{className:"font-medium capitalize",children:s.genre})]})]}),s.genres&&s.genres.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1.5",children:s.genres.map((t,a)=>e.jsx("span",{className:"px-2 py-0.5 rounded-full text-xs font-medium bg-primary/10 text-primary",children:t},a))}),s.genre_description&&e.jsx("p",{className:"text-sm text-muted-foreground leading-relaxed",children:s.genre_description}),(s.songwriter||s.producer||s.label||s.release_date)&&e.jsxs("div",{className:"text-xs text-muted-foreground space-y-1 pt-2 border-t border-border/50",children:[s.songwriter&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Written by:"})," ",s.songwriter]}),s.producer&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Produced by:"})," ",s.producer]}),s.label&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Label:"})," ",s.label]}),s.release_date&&e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Released:"})," ",new Date(s.release_date).toLocaleDateString()]})]}),s.id&&e.jsx("div",{className:"pt-4 border-t border-border/50",children:e.jsx(ee,{trackId:s.id})}),e.jsx("div",{className:"flex gap-3 pt-2",children:e.jsx(ie,{track:{spotifyId:s.spotify_id,youtubeId:s.youtube_id},canonicalTrackId:s.id,trackTitle:s.title,trackArtist:s.artist,size:"lg"})})]})]}),e.jsxs(le,{defaultValue:"sections",className:"w-full",children:[e.jsxs(de,{className:"w-full grid grid-cols-5",children:[e.jsx(j,{value:"sections",children:"Sections"}),e.jsx(j,{value:"chords",children:"Chords"}),e.jsx(j,{value:"samples",children:"Samples"}),e.jsx(j,{value:"videos",children:"Videos"}),e.jsx(j,{value:"comments",children:"Comments"})]}),e.jsx(b,{value:"sections",className:"space-y-3",children:e.jsxs(g,{className:"p-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-muted-foreground mb-3",children:"Song Structure"}),e.jsx("div",{className:"space-y-2",children:N.map(t=>{const a=(i==null?void 0:i.id)===t.id;return e.jsxs("button",{onClick:()=>A(t),className:k("w-full p-3 glass rounded-lg text-left transition-all group",a?"bg-primary/20 border-primary/50 shadow-lg":"hover:bg-muted/50"),children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:k("font-medium capitalize flex items-center gap-2",a&&"text-primary"),children:[t.label,a&&e.jsx("span",{className:"text-xs animate-pulse",children:"●"}),!a&&e.jsx(V,{className:"w-3 h-3 opacity-0 group-hover:opacity-100 transition-opacity"})]}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[P(t.start_ms)," - ",P(t.end_ms)]})]}),e.jsxs("div",{className:"flex-shrink-0 ml-4 flex flex-col items-end",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:ne(t.end_ms-t.start_ms)}),(m&&m[0]||s.youtube_id)&&e.jsx("div",{className:"mt-2",children:e.jsx(S,{size:"sm",variant:"outline",onClick:()=>{var r;return p({canonicalTrackId:s.id,provider:"youtube",providerTrackId:m&&((r=m[0])==null?void 0:r.videoId)||s.youtube_id,autoplay:!0,startSec:Math.floor(t.start_ms/1e3),context:"section-snippet",title:s.title,artist:s.artist})},className:"text-xs h-8 px-3",children:"Play section"})})]})]}),t.chords&&t.chords.length>0&&e.jsx("div",{className:"flex gap-2 flex-wrap mt-2",children:t.chords.map((r,x)=>{const o=a&&F===x;return e.jsx(L,{chord:r,keySignature:s.detected_key,size:"lg",className:k("transition-all duration-200",o&&"ring-2 ring-primary scale-110 shadow-lg")},x)})})]},t.id)})})]})}),e.jsx(b,{value:"chords",className:"space-y-3",children:e.jsxs(g,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"text-sm font-semibold text-muted-foreground",children:"Chord Progression"}),(_==null?void 0:_.source)==="local"&&e.jsx("span",{className:"text-xs text-muted-foreground",children:"Local data"})]}),s.progression_roman&&s.progression_roman.length>0?e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"flex gap-2.5 flex-wrap",children:s.progression_roman.map((t,a)=>e.jsx(L,{chord:t,keySignature:s.detected_key,size:"lg"},a))}),s.detected_key&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Key: ",s.detected_key," ",s.detected_mode]})]}):e.jsx("p",{className:"text-sm text-muted-foreground",children:"No chord data available"})]})}),e.jsx(b,{value:"samples",className:"space-y-3",children:e.jsxs(g,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"text-sm font-semibold text-muted-foreground",children:"Sample Connections"}),e.jsxs(S,{variant:"ghost",size:"sm",className:"h-7 text-xs",children:[e.jsx(me,{className:"w-3 h-3 mr-1"}),"WhoSampled"]})]}),e.jsxs("div",{className:"text-center py-8",children:[e.jsx(xe,{className:"w-8 h-8 text-muted-foreground mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"No sample data available yet"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"WhoSampled integration coming soon"})]})]})}),e.jsx(b,{value:"videos",className:"space-y-3",children:e.jsxs(g,{className:"p-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-muted-foreground mb-3",children:"Video Sources"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:"Click the Play button above to start playback. Video player continues across navigation."}),e.jsx("div",{className:"space-y-2",children:O?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(I,{className:"w-8 h-8 text-muted-foreground mx-auto mb-2 animate-pulse"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Searching YouTube..."})]}):e.jsxs(e.Fragment,{children:[m.map(t=>e.jsxs("button",{onClick:()=>R(t),className:"w-full p-3 glass rounded-lg text-left hover:bg-muted/50 transition-colors flex items-center gap-3",children:[e.jsx(V,{className:"w-4 h-4 text-primary flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium truncate",children:t.title}),e.jsx("div",{className:"text-xs text-muted-foreground capitalize",children:t.type})]}),v==="youtube"&&c===t.videoId&&e.jsx("span",{className:"text-xs text-primary",children:"Playing"})]},t.id)),m.length===0&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx(I,{className:"w-8 h-8 text-muted-foreground mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"No videos available"})]})]})})]})}),e.jsx(b,{value:"comments",className:"space-y-3",children:e.jsx(g,{className:"p-6",children:e.jsx(se,{trackId:n||""})})})]})]}),e.jsx(ue,{trackId:n||"",likes:Math.floor(Math.random()*1e3),onComment:()=>{const t=document.querySelector('[value="comments"]');t==null||t.scrollIntoView({behavior:"smooth"})},onShare:()=>{navigator.share&&navigator.share({title:`${s.title} - ${s.artist}`,url:window.location.href})}}),e.jsx(X,{trackId:n,maxVisible:3,scrollSpeed:4e3}),e.jsx(Z,{})]})}export{ss as default};
