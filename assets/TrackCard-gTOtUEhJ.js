import{c as A,j as e,m as g,r as p,X as J,i as w,ag as pe,a as M,g as F,h as ee,s as _,u as te,B as C,f as xe,k as fe,b as se,P as ae,ah as ge,S as ye}from"./index-DJstQ7TQ.js";import{C as be}from"./ChordBadge-BNUlfBzj.js";import{K as je,R as we}from"./rotate-ccw-B17EBhrP.js";import{M as Ne}from"./music-BcculZu3.js";import{D as ve,a as _e,E as Ce,b as Se,c as T,d as Y,T as Me}from"./TrackComments-BaZOVkYo.js";import{R as ke,T as Pe,P as Te,C as ie,a as Ae,b as ne,O as re,D as oe,S as Re}from"./switch-DOlDwAWF.js";import{A as Ie,a as ze,b as $e}from"./avatar-B9YNfGAG.js";import{S as qe}from"./scroll-area-Cvkbx7IZ.js";import{S as De,b as Le}from"./useFollowing-wuFeR5Zi.js";import{L as X}from"./label-CwTAQOyR.js";import{u as V}from"./useMutation-BMXGyvN9.js";import{U as O}from"./users-D6SjDL31.js";import{A as U}from"./index-CySkcPGr.js";import{M as q}from"./map-pin-BPPzt0rt.js";import{R as Oe}from"./radio-Cn5PDXX7.js";import{f as Ee}from"./formatDistanceToNow-3UBXKcFR.js";import{S as E}from"./share-2-lTF_4Mdv.js";import{C as Ue}from"./check-DciRYEuX.js";import{T as Fe}from"./twitter-BE9lTtOu.js";import{M as Ve,S as Ke}from"./send-CevVhtlX.js";import{Q as Qe}from"./QuickStreamButtons-rAG91GQ3.js";import{a as Z}from"./timeFormat-BXo_t6_Q.js";import{L as He,U as Be}from"./BottomNav-BBt5RMVb.js";import{M as We}from"./music-2-BQxEJYw0.js";import{A as Ye}from"./CladeIcon-BwtohWFc.js";import{S as Xe}from"./sparkles-BOGg8Uc_.js";import{H as Ze}from"./heart-Bsfw_trc.js";import{W as Ge}from"./waves-7C_mNnZf.js";import{B as Je}from"./bookmark-ki4rP6VL.js";import{M as et}from"./search-DBI_ibCX.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const tt=A("Album",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["polyline",{points:"11 3 11 11 14 8 17 11 17 3",key:"1wcwz3"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const st=A("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const le=A("Link2",[["path",{d:"M9 17H7A5 5 0 0 1 7 7h2",key:"8i5ue5"}],["path",{d:"M15 7h2a5 5 0 1 1 0 10h-2",key:"1b9ql8"}],["line",{x1:"8",x2:"16",y1:"12",y2:"12",key:"1jonct"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const at=A("Settings2",[["path",{d:"M20 7h-9",key:"3s1dr2"}],["path",{d:"M14 17H5",key:"gfn3mx"}],["circle",{cx:"17",cy:"17",r:"3",key:"18b49y"}],["circle",{cx:"7",cy:"7",r:"3",key:"dfmy0x"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const it=A("SquarePlay",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"m9 8 6 4-6 4Z",key:"f1r3lt"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const nt=A("Youtube",[["path",{d:"M2.5 17a24.12 24.12 0 0 1 0-10 2 2 0 0 1 1.4-1.4 49.56 49.56 0 0 1 16.2 0A2 2 0 0 1 21.5 7a24.12 24.12 0 0 1 0 10 2 2 0 0 1-1.4 1.4 49.55 49.55 0 0 1-16.2 0A2 2 0 0 1 2.5 17",key:"1q2vi4"}],["path",{d:"m10 15 5-3-5-3z",key:"1jp15x"}]]);function rt({progression:t,detectedKey:s,detectedMode:a,cadenceType:i,confidenceScore:l,matchReason:x}){return e.jsxs(g.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"glass-strong rounded-2xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(je,{className:"w-4 h-4"}),e.jsxs("span",{className:"text-sm font-medium",children:[s||"Unknown"," ",a&&a!=="unknown"?a:""]})]}),i&&i!=="none"&&e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-muted-foreground",children:[e.jsx(we,{className:"w-3 h-3"}),e.jsx("span",{className:"capitalize",children:i})]})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(Ne,{className:"w-4 h-4 text-primary shrink-0"}),e.jsx("div",{className:"flex flex-wrap gap-1.5",children:t.map((m,d)=>e.jsx(g.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},transition:{delay:d*.05},children:e.jsx(be,{chord:m,size:"md",keySignature:s})},d))})]}),x&&e.jsx("p",{className:"text-xs text-muted-foreground leading-relaxed pt-1 border-t border-border/50",children:x}),l!==void 0&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex-1 h-1 bg-muted rounded-full overflow-hidden",children:e.jsx(g.div,{initial:{width:0},animate:{width:`${l*100}%`},transition:{delay:.3,duration:.5},className:"h-full bg-gradient-to-r from-primary to-accent rounded-full"})}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[Math.round(l*100),"%"]})]})]})}const de=ke,ce=Pe,ot=Te,me=p.forwardRef(({className:t,...s},a)=>e.jsx(re,{className:w("fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",t),...s,ref:a}));me.displayName=re.displayName;const lt=pe("fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500",{variants:{side:{top:"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",bottom:"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",left:"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",right:"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm"}},defaultVariants:{side:"right"}}),K=p.forwardRef(({side:t="right",className:s,children:a,...i},l)=>e.jsxs(ot,{children:[e.jsx(me,{}),e.jsxs(ie,{ref:l,className:w(lt({side:t}),s),...i,children:[a,e.jsxs(Ae,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity data-[state=open]:bg-secondary hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none",children:[e.jsx(J,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Close"})]})]})]}));K.displayName=ie.displayName;const Q=({className:t,...s})=>e.jsx("div",{className:w("flex flex-col space-y-2 text-center sm:text-left",t),...s});Q.displayName="SheetHeader";const H=p.forwardRef(({className:t,...s},a)=>e.jsx(ne,{ref:a,className:w("text-lg font-semibold text-foreground",t),...s}));H.displayName=ne.displayName;const dt=p.forwardRef(({className:t,...s},a)=>e.jsx(oe,{ref:a,className:w("text-sm text-muted-foreground",t),...s}));dt.displayName=oe.displayName;function G(t,s,a,i){const x=(a-t)*Math.PI/180,m=(i-s)*Math.PI/180,d=Math.sin(x/2)*Math.sin(x/2)+Math.cos(t*Math.PI/180)*Math.cos(a*Math.PI/180)*Math.sin(m/2)*Math.sin(m/2);return 6371*(2*Math.atan2(Math.sqrt(d),Math.sqrt(1-d)))}function ue(){const{user:t}=M(),s=typeof window<"u"&&window.location.hostname.endsWith("github.io");return F({queryKey:["user-location",t==null?void 0:t.id],queryFn:async()=>{if(!t||s)return null;const{data:a,error:i}=await _.from("user_locations").select("*").eq("user_id",t.id).maybeSingle();if(i)throw i;return a},enabled:!!t&&!s})}function ct(){const t=ee(),{user:s}=M();return V({mutationFn:async({latitude:a,longitude:i,sharingEnabled:l=!0,radiusKm:x=50})=>{if(!s)throw new Error("Must be logged in");const{data:m,error:d}=await _.from("user_locations").upsert({user_id:s.id,latitude:a,longitude:i,sharing_enabled:l,radius_km:x}).select().single();if(d)throw d;return m},onSuccess:()=>{t.invalidateQueries({queryKey:["user-location"]}),t.invalidateQueries({queryKey:["nearby-listeners"]})}})}function mt(){const t=ee(),{user:s}=M();return V({mutationFn:async()=>{if(!s)throw new Error("Must be logged in");const{error:a}=await _.from("user_locations").update({sharing_enabled:!1}).eq("user_id",s.id);if(a)throw a},onSuccess:()=>{t.invalidateQueries({queryKey:["user-location"]})}})}function ut(t,s){const{user:a}=M(),{data:i}=ue();return F({queryKey:["nearby-listeners",t,s,i==null?void 0:i.latitude,i==null?void 0:i.longitude],queryFn:async()=>{if(!a||!(i!=null&&i.sharing_enabled))return[];const{data:l,error:x}=await _.from("user_locations").select("user_id, latitude_fuzzy, longitude_fuzzy").eq("sharing_enabled",!0).neq("user_id",a.id);if(x)throw x;const m=(l||[]).filter(r=>G(i.latitude,i.longitude,Number(r.latitude_fuzzy),Number(r.longitude_fuzzy))<=i.radius_km).map(r=>({user_id:r.user_id,distance_km:G(i.latitude,i.longitude,Number(r.latitude_fuzzy),Number(r.longitude_fuzzy))}));if(m.length===0)return[];const{data:d,error:h}=await _.from("profiles").select("id, display_name, avatar_url").in("id",m.map(r=>r.user_id));if(h)throw h;let b=[];if(t||s){let r=_.from("nearby_activity").select("*").in("user_id",m.map(n=>n.user_id)).order("listened_at",{ascending:!1});if(t&&(r=r.eq("track_id",t)),s){const n=s.replace(/[%_]/g,"\\$&");r=r.ilike("artist",`%${n}%`)}const{data:o}=await r;b=o||[]}return m.map(({user_id:r,distance_km:o})=>{const n=(d||[]).find(y=>y.id===r),u=b.find(y=>y.user_id===r);return{user_id:r,display_name:(n==null?void 0:n.display_name)||"Anonymous",avatar_url:n==null?void 0:n.avatar_url,distance_km:Math.round(o*10)/10,last_track:u==null?void 0:u.track_id,last_artist:u==null?void 0:u.artist,listened_at:u==null?void 0:u.listened_at}}).filter(r=>!t&&!s?!0:b.some(o=>o.user_id===r.user_id)).sort((r,o)=>r.distance_km-o.distance_km)},enabled:!!a&&!!(i!=null&&i.sharing_enabled)})}function ht(){const{user:t}=M();return V({mutationFn:async({trackId:s,artist:a})=>{if(!t)return;const{error:i}=await _.from("nearby_activity").insert({user_id:t.id,track_id:s,artist:a||null});if(i)throw i}})}function pt({trackId:t,artist:s,trackTitle:a}){const[i,l]=p.useState(!1),[x,m]=p.useState(!1),[d,h]=p.useState(50),[b,j]=p.useState(!1),{user:r}=M(),o=te(),{data:n,isLoading:u}=ue(),{data:y=[],isLoading:S}=ut(t,s),N=ct(),z=mt();p.useEffect(()=>{n!=null&&n.radius_km&&h(n.radius_km)},[n==null?void 0:n.radius_km]);const $=async()=>{if(!r){o("/auth");return}j(!0);try{const c=await new Promise((v,P)=>{navigator.geolocation.getCurrentPosition(v,P,{enableHighAccuracy:!1,timeout:1e4,maximumAge:3e5})});await N.mutateAsync({latitude:c.coords.latitude,longitude:c.coords.longitude,sharingEnabled:!0,radiusKm:d})}catch(c){console.error("Location error:",c)}finally{j(!1)}},D=async c=>{const v=c[0];h(v),n&&await N.mutateAsync({latitude:n.latitude,longitude:n.longitude,sharingEnabled:!0,radiusKm:v})},L=async c=>{c&&!n?await $():c?n&&await N.mutateAsync({latitude:n.latitude,longitude:n.longitude,sharingEnabled:c,radiusKm:d}):await z.mutateAsync()},k=(n==null?void 0:n.sharing_enabled)??!1;return e.jsxs(de,{open:i,onOpenChange:l,children:[e.jsx(ce,{asChild:!0,children:e.jsxs(g.button,{whileTap:{scale:.9},className:"flex flex-col items-center gap-1 p-3 rounded-xl transition-all text-muted-foreground hover:text-foreground",children:[e.jsxs("div",{className:"p-3 rounded-full bg-muted/50 hover:bg-muted transition-all relative",children:[e.jsx(O,{className:"w-6 h-6"}),k&&y.length>0&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-accent text-accent-foreground text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center",children:y.length})]}),e.jsx("span",{className:"text-xs font-medium",children:"Nearby"})]})}),e.jsxs(K,{side:"bottom",className:"h-[80vh] rounded-t-3xl",children:[e.jsx(Q,{className:"pb-4 border-b border-border",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(H,{className:"flex items-center gap-2",children:[e.jsx(O,{className:"w-5 h-5 text-accent"}),a?`Listeners of "${a}"`:"Nearby Music Lovers"]}),e.jsx(C,{variant:"ghost",size:"icon",onClick:()=>m(!x),className:"h-8 w-8",children:e.jsx(at,{className:"w-4 h-4"})})]})}),e.jsx(U,{children:x&&e.jsx(g.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},className:"overflow-hidden border-b border-border",children:e.jsxs("div",{className:"py-4 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(q,{className:"w-4 h-4 text-primary"}),e.jsx(X,{htmlFor:"location-sharing",children:"Share my location"})]}),e.jsx(Re,{id:"location-sharing",checked:k,onCheckedChange:L,disabled:N.isPending||z.isPending})]}),k&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(X,{children:"Discovery radius"}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[d," km"]})]}),e.jsx(De,{value:[d],onValueChange:D,min:5,max:100,step:5,className:"w-full"})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Your location is only visible to others who also share theirs."})]})})}),e.jsx("div",{className:"flex flex-col h-[calc(80vh-10rem)]",children:e.jsx(qe,{className:"flex-1 py-4",children:r?k?S||u?e.jsx("div",{className:"space-y-4",children:[1,2,3].map(c=>e.jsxs("div",{className:"flex gap-3 animate-pulse",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-muted"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("div",{className:"h-4 w-32 bg-muted rounded"}),e.jsx("div",{className:"h-3 w-24 bg-muted rounded"})]})]},c))}):y.length===0?e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(Oe,{className:"w-12 h-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"No listeners nearby yet"}),e.jsx("p",{className:"text-sm",children:"Check back later or expand your radius"})]}):e.jsx(U,{mode:"popLayout",children:y.map((c,v)=>{var P;return e.jsxs(g.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:v*.05},className:"flex gap-3 mb-4 p-3 rounded-xl glass hover:bg-muted/30 transition-colors",children:[e.jsxs(Ie,{className:"w-12 h-12",children:[e.jsx(ze,{src:c.avatar_url}),e.jsx($e,{className:"bg-accent/20 text-accent",children:((P=c.display_name)==null?void 0:P.charAt(0).toUpperCase())||"A"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:c.display_name}),e.jsxs("span",{className:"text-xs text-muted-foreground flex items-center gap-1",children:[e.jsx(q,{className:"w-3 h-3"}),c.distance_km," km"]})]}),c.last_artist&&e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:["Recently listened to ",c.last_artist]}),c.listened_at&&e.jsx("p",{className:"text-xs text-muted-foreground",children:Ee(new Date(c.listened_at),{addSuffix:!0})})]})]},c.user_id)})}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(q,{className:"w-12 h-12 mx-auto mb-3 text-muted-foreground opacity-50"}),e.jsx("p",{className:"text-muted-foreground mb-2",children:"Enable location sharing"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Discover people nearby who love the same music"}),e.jsxs(C,{onClick:$,disabled:b,className:"gap-2",children:[b?e.jsx(xe,{className:"w-4 h-4 animate-spin"}):e.jsx(q,{className:"w-4 h-4"}),"Enable Location"]})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(O,{className:"w-12 h-12 mx-auto mb-3 text-muted-foreground opacity-50"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Sign in to discover nearby listeners"}),e.jsx(C,{onClick:()=>o("/auth"),children:"Sign In"})]})})})]})]})}function xt({track:t,onShare:s}){const[a,i]=p.useState(!1),[l,x]=p.useState(!1),{toast:m}=fe(),d=`${window.location.origin}/track/${t.id}`,h=`Check out "${t.title}" by ${t.artist} on HarmonyFeed! ðŸŽµ`,b=async()=>{try{await navigator.clipboard.writeText(d),x(!0),m({title:"Link copied!"}),setTimeout(()=>x(!1),2e3),s==null||s()}catch{m({title:"Failed to copy",variant:"destructive"})}},j=async()=>{if(navigator.share)try{await navigator.share({title:t.title,text:h,url:d}),s==null||s(),i(!1)}catch{}},r=[{name:"Copy Link",icon:l?Ue:st,onClick:b,className:l?"text-green-500":""},{name:"Twitter/X",icon:Fe,onClick:()=>{window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(h)}&url=${encodeURIComponent(d)}`,"_blank"),s==null||s()}},{name:"WhatsApp",icon:Ve,onClick:()=>{window.open(`https://wa.me/?text=${encodeURIComponent(h+" "+d)}`,"_blank"),s==null||s()}},{name:"Telegram",icon:Ke,onClick:()=>{window.open(`https://t.me/share/url?url=${encodeURIComponent(d)}&text=${encodeURIComponent(h)}`,"_blank"),s==null||s()}}];return e.jsxs(de,{open:a,onOpenChange:i,children:[e.jsx(ce,{asChild:!0,children:e.jsxs(C,{variant:"ghost",size:"sm",className:"text-muted-foreground hover:text-foreground gap-2",children:[e.jsx(E,{className:"w-4 h-4"}),"Share"]})}),e.jsxs(K,{side:"bottom",className:"rounded-t-3xl",children:[e.jsx(Q,{className:"pb-4",children:e.jsxs(H,{className:"flex items-center gap-2",children:[e.jsx(E,{className:"w-5 h-5 text-primary"}),'Share "',t.title,'"']})}),e.jsxs("div",{className:"space-y-4 pb-8",children:[e.jsxs("div",{className:"flex gap-3 p-3 rounded-xl glass",children:[t.cover_url?e.jsx("img",{src:t.cover_url,alt:"",className:"w-16 h-16 rounded-lg object-cover"}):e.jsx("div",{className:"w-16 h-16 rounded-lg bg-muted flex items-center justify-center",children:e.jsx(le,{className:"w-6 h-6 text-muted-foreground"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-medium truncate",children:t.title}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:t.artist})]})]}),typeof navigator<"u"&&"share"in navigator&&e.jsxs(C,{onClick:j,className:"w-full gap-2",variant:"default",children:[e.jsx(E,{className:"w-4 h-4"}),"Share"]}),e.jsx("div",{className:"grid grid-cols-4 gap-3",children:r.map(o=>e.jsxs(g.button,{whileTap:{scale:.95},onClick:o.onClick,className:"flex flex-col items-center gap-2 p-3 rounded-xl hover:bg-muted/50 transition-colors",children:[e.jsx("div",{className:`p-3 rounded-full bg-muted ${o.className||""}`,children:e.jsx(o.icon,{className:"w-5 h-5"})}),e.jsx("span",{className:"text-xs text-muted-foreground",children:o.name})]},o.name))})]})]})]})}const ft={intro:"bg-blue-500/20 text-blue-300 border-blue-500/30",verse:"bg-purple-500/20 text-purple-300 border-purple-500/30","pre-chorus":"bg-pink-500/20 text-pink-300 border-pink-500/30",chorus:"bg-green-500/20 text-green-300 border-green-500/30",bridge:"bg-orange-500/20 text-orange-300 border-orange-500/30",outro:"bg-red-500/20 text-red-300 border-red-500/30",breakdown:"bg-yellow-500/20 text-yellow-300 border-yellow-500/30",drop:"bg-cyan-500/20 text-cyan-300 border-cyan-500/30"};function gt({sections:t,youtubeId:s,spotifyId:a,trackTitle:i,trackArtist:l,canonicalTrackId:x=null,className:m}){const{openPlayer:d,seekTo:h,youtubeOpen:b,youtubeTrackId:j,spotifyOpen:r,spotifyTrackId:o}=se(),n=u=>{const y=Math.floor(u.start_ms/1e3),S=b&&(j==null?void 0:j.includes(s||""));s?S?h(y):d({canonicalTrackId:null,provider:"youtube",providerTrackId:s,autoplay:!0,startSec:y}):a&&!(r&&o===a)&&d({canonicalTrackId:null,provider:"spotify",providerTrackId:a,autoplay:!0})};return!t||t.length===0?null:e.jsx("div",{className:w("flex gap-1.5 flex-wrap",m),children:t.map((u,y)=>{const S=ft[u.label]||"bg-muted/20 text-muted-foreground border-muted/30";return e.jsx(g.button,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},transition:{delay:y*.03},onClick:()=>n(u),className:w("group relative px-2 py-1 rounded-md text-xs font-medium","border transition-all hover:scale-105",S),title:`Play from ${u.label} at ${Z(u.start_ms)}`,children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ae,{className:"w-2.5 h-2.5 opacity-0 group-hover:opacity-100 transition-opacity"}),e.jsx("span",{className:"capitalize",children:u.label}),e.jsx("span",{className:"text-[10px] opacity-60",children:Z(u.start_ms)})]})},u.id)})})}function yt({track:t}){const s=te(),{playNext:a,playLater:i}=ge(),l=()=>{t.album&&s(`/album/${encodeURIComponent(t.album)}`)},x=()=>{t.artist&&s(`/artist/${encodeURIComponent(t.artist)}`)},m=()=>{if(t.progression_roman){const h=t.progression_roman.join("-");s(`/search?mode=chord&q=${encodeURIComponent(h)}`)}},d=()=>{s(`/connections/${encodeURIComponent(t.id)}`)};return e.jsxs(ve,{children:[e.jsx(_e,{asChild:!0,children:e.jsx(C,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:h=>h.stopPropagation(),children:e.jsx(Ce,{className:"w-4 h-4"})})}),e.jsxs(Se,{align:"end",className:"w-56",children:[e.jsxs(T,{onClick:()=>a(t),children:[e.jsx(it,{className:"w-4 h-4 mr-2"}),"Play Next"]}),e.jsxs(T,{onClick:()=>i(t),children:[e.jsx(He,{className:"w-4 h-4 mr-2"}),"Add to Queue"]}),e.jsx(Y,{}),t.album&&e.jsxs(T,{onClick:l,children:[e.jsx(tt,{className:"w-4 h-4 mr-2"}),"View Album"]}),t.artist&&e.jsxs(T,{onClick:x,children:[e.jsx(Be,{className:"w-4 h-4 mr-2"}),"View Artist"]}),e.jsx(Y,{}),t.progression_roman&&t.progression_roman.length>0&&e.jsxs(T,{onClick:m,children:[e.jsx(We,{className:"w-4 h-4 mr-2"}),"Similar Chord Progressions"]}),e.jsxs(T,{onClick:d,children:[e.jsx(le,{className:"w-4 h-4 mr-2"}),"View Samples & Connections"]})]})]})}function bt(t){return F({queryKey:["track-comments",t],queryFn:async()=>{try{const{data:s,error:a}=await _.from("track_comments").select("*").eq("track_id",t).order("created_at",{ascending:!0});return a?(console.warn("[Comments] track_comments fetch skipped due to schema error",a),[]):(s||[]).map(i=>({...i,user_display_name:"Anonymous",user_avatar_url:void 0}))}catch(s){return console.error("Failed to load track comments:",s),[]}},enabled:!!t})}function Xt({track:t,isActive:s,onInteraction:a,interactions:i=new Set,onPipModeActivate:l,isPipActive:x=!1}){const{user:m,guestMode:d}=M(),[h,b]=p.useState(!1),[j,r]=p.useState(!1),o=p.useRef(null),n=p.useRef(null),u=ht(),y=Le(),{openPlayer:S}=se(),{data:N}=bt(t.id),z=(N==null?void 0:N.length)||0,$=p.useCallback(f=>f.map((R,B)=>{var W;return{id:`${t.id}-${R.type}-${B}`,track_id:t.id,label:R.type,start_ms:R.start_time*1e3,end_ms:R.end_time?R.end_time*1e3:(((W=f[B+1])==null?void 0:W.start_time)||t.duration_ms||24e4/1e3)*1e3,created_at:new Date().toISOString()}}),[t.id,t.duration_ms]),D=p.useCallback(()=>{const f=t.duration_ms||24e4;return[{id:`${t.id}-intro`,track_id:t.id,label:"intro",start_ms:0,end_ms:Math.floor(f*.1),created_at:new Date().toISOString()},{id:`${t.id}-verse1`,track_id:t.id,label:"verse",start_ms:Math.floor(f*.1),end_ms:Math.floor(f*.3),created_at:new Date().toISOString()},{id:`${t.id}-chorus1`,track_id:t.id,label:"chorus",start_ms:Math.floor(f*.3),end_ms:Math.floor(f*.5),created_at:new Date().toISOString()},{id:`${t.id}-verse2`,track_id:t.id,label:"verse",start_ms:Math.floor(f*.5),end_ms:Math.floor(f*.65),created_at:new Date().toISOString()},{id:`${t.id}-chorus2`,track_id:t.id,label:"chorus",start_ms:Math.floor(f*.65),end_ms:Math.floor(f*.85),created_at:new Date().toISOString()},{id:`${t.id}-outro`,track_id:t.id,label:"outro",start_ms:Math.floor(f*.85),end_ms:f,created_at:new Date().toISOString()}]},[t.id,t.duration_ms]),L=t.sections&&t.sections.length>0?$(t.sections):D();p.useEffect(()=>{!s&&h&&c()},[s]),p.useEffect(()=>()=>{o.current&&o.current.pause()},[]);const k=p.useCallback(async()=>{if(o.current&&t.preview_url)try{await o.current.play(),b(!0),n.current=Date.now(),u.mutate({trackId:t.id,artist:t.artist})}catch(f){console.error("Playback failed:",f)}},[t.preview_url,t.id,t.artist,u]),c=p.useCallback(()=>{if(o.current&&(o.current.pause(),b(!1),n.current&&m)){const f=Date.now()-n.current;y.mutate({trackId:t.id,durationMs:f,source:"feed"}),n.current=null}},[m,t.id,y]),v=()=>{h?c():k()},P=()=>{if(b(!1),n.current&&m){const f=Date.now()-n.current;y.mutate({trackId:t.id,durationMs:f,source:"feed"}),n.current=null}},he=()=>{a("share")};return e.jsxs(g.div,{initial:{opacity:0},animate:{opacity:s?1:.5},className:"relative w-full h-full flex flex-col","data-track-card":t.id,children:[t.preview_url&&e.jsx("audio",{ref:o,src:t.preview_url,preload:"none",onEnded:P}),e.jsx("div",{className:"absolute inset-0 z-0",children:t.cover_url?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:t.cover_url,alt:"",className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-background via-background/80 to-background/40"})]}):e.jsx("div",{className:"w-full h-full bg-gradient-to-br from-secondary to-background"})}),e.jsxs("div",{className:"relative z-10 flex-1 flex flex-col justify-end p-6 pb-8 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs(g.h2,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},className:"text-2xl font-bold text-foreground line-clamp-2 flex-1 flex items-center gap-2",children:[e.jsx("span",{children:t.title}),t.is_common_ancestor&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-gradient-to-r from-amber-500/20 to-orange-500/20 border border-amber-500/30",title:"Common Ancestor - Foundational track that influenced a musical movement",children:[e.jsx(Ye,{size:14,className:"text-amber-400"}),e.jsx("span",{className:"text-[10px] font-semibold text-amber-400 uppercase tracking-wide",children:"Ancestor"})]})]}),e.jsx(yt,{track:t})]}),e.jsx(g.p,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.05},className:"text-lg text-muted-foreground",children:t.artist}),(t.tempo||t.genre)&&e.jsxs(g.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.07},className:"flex items-center gap-2 text-sm text-muted-foreground",children:[t.tempo&&e.jsxs("span",{className:"font-medium",children:[Math.round(t.tempo)," BPM"]}),t.tempo&&t.genre&&e.jsx("span",{children:"â€¢"}),t.genre&&e.jsx("span",{className:"capitalize",children:t.genre})]})]}),e.jsx(g.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.08},children:e.jsx(gt,{sections:L,youtubeId:t.youtube_id,spotifyId:t.spotify_id,trackTitle:t.title,trackArtist:t.artist||"",canonicalTrackId:t.id})}),e.jsxs(g.div,{initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},transition:{delay:.1},className:"flex items-center gap-3",children:[t.preview_url&&e.jsxs(C,{variant:"outline",size:"lg",onClick:v,className:"gap-2 glass border-white/20 hover:bg-white/10",children:[h?e.jsx(ye,{className:"w-5 h-5"}):e.jsx(ae,{className:"w-5 h-5"}),h?"Pause":"Preview"]}),t.youtube_id&&e.jsxs(C,{variant:"outline",size:"lg",onClick:()=>S({canonicalTrackId:t.id,provider:"youtube",providerTrackId:t.youtube_id,autoplay:!0,context:"feed-card-watch",title:t.title,artist:t.artist}),className:"gap-2 glass border-white/20 hover:bg-white/10",children:[e.jsx(nt,{className:"w-5 h-5"}),"Watch"]}),e.jsx(Qe,{track:{spotifyId:t.spotify_id||void 0,youtubeId:t.youtube_id||void 0,urlSpotifyWeb:t.url_spotify_web||void 0,urlSpotifyApp:t.url_spotify_app||void 0,urlYoutube:t.url_youtube||void 0},canonicalTrackId:t.id,trackTitle:t.title,trackArtist:t.artist,size:"md"})]}),t.progression_roman&&t.progression_roman.length>0&&e.jsx(g.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.15},children:e.jsx(rt,{progression:t.progression_roman,detectedKey:t.detected_key,detectedMode:t.detected_mode,cadenceType:t.cadence_type,confidenceScore:t.confidence_score,matchReason:"Same viâ€“IVâ€“Iâ€“V loop with similar energy"})}),e.jsxs(g.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.2},className:"flex items-center justify-between pt-4 relative z-20",children:[e.jsx(I,{icon:J,label:"Skip",isActive:i.has("skip"),onClick:()=>a("skip"),variant:"muted"}),e.jsx(I,{icon:Xe,label:"Harmonic",isActive:i.has("more_harmonic"),onClick:()=>a("more_harmonic"),variant:"primary"}),e.jsx(I,{icon:Ze,label:"Like",isActive:i.has("like"),onClick:()=>a("like"),variant:"accent"}),e.jsx(I,{icon:Ge,label:"Vibe",isActive:i.has("more_vibe"),onClick:()=>a("more_vibe"),variant:"primary"}),e.jsx(I,{icon:Je,label:"Save",isActive:i.has("save"),onClick:()=>a("save"),variant:"muted"})]}),e.jsxs(g.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.25},className:"flex items-center justify-center gap-4",children:[e.jsxs(g.button,{whileTap:{scale:.9},onClick:()=>r(!j),className:"flex items-center gap-2 px-4 py-2 rounded-full bg-muted/50 hover:bg-muted transition-all text-muted-foreground hover:text-foreground",children:[e.jsx(et,{className:"w-5 h-5"}),e.jsx("span",{className:"text-sm font-medium",children:z})]}),e.jsx(pt,{trackId:t.id,artist:t.artist,trackTitle:t.title}),e.jsx(xt,{track:t,onShare:he})]}),e.jsx(U,{children:j&&e.jsx(g.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:.3},className:"overflow-hidden",children:e.jsx("div",{className:"mt-6 pt-6 border-t border-border/50",children:e.jsx(Me,{trackId:t.id})})})})]})]})}function I({icon:t,label:s,isActive:a,onClick:i,variant:l}){return e.jsxs(g.button,{whileTap:{scale:.9},onClick:i,className:w("flex flex-col items-center gap-1 p-3 rounded-xl transition-all",a&&l==="accent"&&"text-accent glow-accent",a&&l==="primary"&&"text-primary glow-primary",a&&l==="muted"&&"text-foreground",!a&&"text-muted-foreground hover:text-foreground"),children:[e.jsx("div",{className:w("p-3 rounded-full transition-all",a&&l==="accent"&&"bg-accent/20",a&&l==="primary"&&"bg-primary/20",a&&l==="muted"&&"bg-muted",!a&&"bg-muted/50 hover:bg-muted"),children:e.jsx(t,{className:w("w-6 h-6",a&&l==="accent"&&"fill-current")})}),e.jsx("span",{className:"text-xs font-medium",children:s})]})}export{Xt as T};
