import{r as m,j as l,m as T,s as p,a as C,h as _}from"./index-c329HF_1.js";import{A as S}from"./index-D7xJxKgH.js";import{s as v}from"./seedTracks-B22TRa5Y.js";import{g as E,b as j}from"./youtubeSearchService-lZc7ageC.js";function Y({trackId:e,roomId:t="global",maxVisible:n=5,scrollSpeed:o=5e3}){const[s,r]=m.useState([]),[f,d]=m.useState([]);return m.useEffect(()=>{let a=null;return(async()=>{const g=e?p.from("track_comments").select("id, content, profiles(full_name), created_at").eq("track_id",e).order("created_at",{ascending:!1}).limit(20):p.from("chat_messages").select("id, content, profiles(full_name), created_at").eq("room_id",t).order("created_at",{ascending:!1}).limit(20),{data:b}=await g;if(b){const u=b.map(c=>{var h;return{id:c.id,content:c.content,author:((h=c.profiles)==null?void 0:h.full_name)||"Anonymous",created_at:c.created_at}});r(u.reverse())}const y=e?"track_comments":"chat_messages";a=p.channel(`scrolling-comments-${e||t}`).on("postgres_changes",{event:"INSERT",schema:"public",table:y,filter:e?`track_id=eq.${e}`:`room_id=eq.${t}`},async u=>{const{data:c}=await p.from("profiles").select("full_name").eq("id",u.new.user_id).single(),h={id:u.new.id,content:u.new.content,author:(c==null?void 0:c.full_name)||"Anonymous",created_at:u.new.created_at};r(x=>[...x,h])}).subscribe()})(),()=>{a==null||a.unsubscribe()}},[e,t]),m.useEffect(()=>{if(s.length===0)return;const a=setInterval(()=>{r(i=>{if(i.length===0)return i;const[g,...b]=i;return d(y=>[...y,g].slice(-n)),b})},o/n);return()=>clearInterval(a)},[s.length,n,o]),m.useEffect(()=>{if(f.length===0)return;const a=setTimeout(()=>{d(i=>i.slice(1))},o);return()=>clearTimeout(a)},[f,o]),l.jsx("div",{className:"fixed bottom-24 left-0 right-0 z-40 pointer-events-none px-4 md:px-8",children:l.jsx("div",{className:"mx-auto max-w-2xl",children:l.jsx(S,{mode:"popLayout",children:f.map((a,i)=>l.jsx(T.div,{initial:{y:50,opacity:0},animate:{y:0,opacity:1-i*.15},exit:{y:-50,opacity:0},transition:{duration:.5,ease:"easeOut"},className:"mb-2",style:{filter:`blur(${i*.5}px)`},children:l.jsx("div",{className:"inline-block rounded-full bg-background/60 backdrop-blur-xl border border-border/30 px-4 py-2 shadow-lg",children:l.jsxs("p",{className:"text-sm text-foreground",children:[l.jsxs("span",{className:"font-semibold",children:[a.author,":"]})," ",l.jsx("span",{className:"font-normal",children:a.content})]})})},a.id))})})})}function A(e){return{...e,sections:Array.isArray(e.sections)?e.sections:void 0,detected_mode:e.detected_mode||void 0}}async function F(e){try{let t=p.from("tracks").select("*");if(e.id&&(t=t.eq("id",e.id)),e.spotifyId&&(t=t.eq("spotify_id",e.spotifyId)),e.youtubeId&&(t=t.eq("youtube_id",e.youtubeId)),e.search){const s=e.search.replace(/[%_,().*\\]/g,"");t=t.or(`title.ilike.%${s}%,artist.ilike.%${s}%`)}e.limit&&(t=t.limit(e.limit)),e.offset&&(t=t.range(e.offset,e.offset+(e.limit||20)-1));const{data:n,error:o}=await t;return o?(console.warn("Database fetch failed:",o.message),null):n?n.map(s=>A(s)):null}catch(t){return console.warn("Database fetch error:",t),null}}function N(e){let t=[...v];if(e.id&&(t=t.filter(s=>s.id===e.id)),e.spotifyId&&(t=t.filter(s=>s.spotify_id===e.spotifyId)),e.youtubeId&&(t=t.filter(s=>s.youtube_id===e.youtubeId)),e.search){const s=e.search.toLowerCase();t=t.filter(r=>{var f,d;return r.title.toLowerCase().includes(s)||((f=r.artist)==null?void 0:f.toLowerCase().includes(s))||((d=r.album)==null?void 0:d.toLowerCase().includes(s))})}const n=e.offset||0,o=e.limit||20;return t.slice(n,n+o)}async function w(e={}){const t=await F(e);if(t&&t.length>0)return{tracks:t,source:"database",total:t.length};const n=N(e);return{tracks:n,source:"seed",total:n.length}}async function I(e){return(await w({id:e,limit:1})).tracks[0]||null}async function L(e=20){return w({limit:e})}const k={profile:["profile"],userProviders:["user-providers"],following:["following"],followers:["followers"],followingFeed:["following-feed"],TRACKS:"tracks",FEED:"feed",trackComments:e=>["track-comments",e],trackConnections:e=>["track-connections",e],playHistory:["play-history"],playStats:["play-stats"],userLocation:["user-location"],nearbyListeners:(e,t)=>["nearby-listeners",e,t],unifiedSearch:e=>["unified-search",e]};function Q(e,t=!0){const{user:n}=C(),o=e==null?void 0:e.startsWith("spotify:");return _({queryKey:[k.TRACKS,"single",e],queryFn:async()=>{if(!e)return null;if(o&&n){const r=e.replace("spotify:","");return await E(n.id,r)}return(e==null?void 0:e.startsWith("youtube:"))?(e.replace("youtube:",""),await j()):await I(e)},enabled:!!e&&t,staleTime:10*60*1e3})}function z(e=20){return _({queryKey:[k.FEED,e],queryFn:()=>L(e),staleTime:5*60*1e3})}export{Y as S,Q as a,z as u};
