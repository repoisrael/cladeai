import{j as T,l as $,t as j,v as h,w as q,a as y,g}from"./index-DHJxnaPT.js";const k={sm:"max-w-screen-sm",md:"max-w-screen-md",lg:"max-w-screen-lg",xl:"max-w-[1440px]","2xl":"max-w-screen-2xl",full:"max-w-full"};function K({children:t,maxWidth:e="xl",className:r,padding:n=!0}){return T.jsx("div",{className:$("mx-auto w-full",k[e],n&&"px-4 sm:px-6 lg:px-8",r),children:t})}const A={sm:"gap-3",md:"gap-4 sm:gap-6",lg:"gap-6 sm:gap-8",xl:"gap-8 sm:gap-10"};function M({children:t,cols:e={sm:1,md:2,lg:3},gap:r="md",className:n}){const a=[e.sm&&`grid-cols-${e.sm}`,e.md&&`sm:grid-cols-${e.md}`,e.lg&&`md:grid-cols-${e.lg}`,e.xl&&`lg:grid-cols-${e.xl}`,e["2xl"]&&`xl:grid-cols-${e["2xl"]}`].filter(Boolean).join(" ");return T.jsx("div",{className:$("grid",a,A[r],n),children:t})}const _="https://api.spotify.com/v1";function C(t){const{track:e}=t,r=e.album.images.sort((n,a)=>a.height-n.height)[0];return{id:`spotify:${e.id}`,title:e.name,artist:e.artists.map(n=>n.name).join(", "),artists:e.artists.map(n=>n.name),album:e.album.name,cover_url:r==null?void 0:r.url,artwork_url:r==null?void 0:r.url,duration_ms:e.duration_ms,spotify_id:e.id,url_spotify_web:e.external_urls.spotify,url_spotify_app:e.uri,preview_url:e.preview_url,provider:"spotify",external_id:e.id,played_at:t.played_at}}async function v(t,e=20){const r=await h(t);if(!r)return null;try{const n=new URLSearchParams({limit:Math.min(e,50).toString()}),a=await fetch(`${_}/me/player/recently-played?${n}`,{headers:{Authorization:`Bearer ${r}`}});if(!a.ok)return a.status===401?await q(t,"")?v(t,e):(console.error("Spotify token refresh failed"),null):(console.error("Failed to fetch recently played:",a.status),null);const s=await a.json(),c=[],i=new Set;for(const m of s.items){const d=C(m),o=d.spotify_id||d.id;if(o&&!i.has(o)&&(i.add(o),c.push(d)),c.length>=e)break}return{tracks:c.slice(0,e),source:"spotify"}}catch(n){return console.error("Error fetching recently played:",n),null}}async function E(t){return await j(t)!==null}async function F(t){var r,n,a;const e=await h(t);if(!e)return null;try{const s=await fetch(`${_}/me`,{headers:{Authorization:`Bearer ${e}`}});if(!s.ok)return null;const c=await s.json();return{displayName:c.display_name||c.id,email:c.email,imageUrl:(n=(r=c.images)==null?void 0:r[0])==null?void 0:n.url,product:c.product,followers:(a=c.followers)==null?void 0:a.total}}catch(s){return console.error("Error fetching Spotify profile:",s),null}}async function b(t,e="medium_term",r=20){const n=await h(t);if(!n)return[];try{const a=new URLSearchParams({time_range:e,limit:Math.min(r,50).toString()}),s=await fetch(`${_}/me/top/tracks?${a}`,{headers:{Authorization:`Bearer ${n}`}});return s.ok?(await s.json()).items.map(i=>{var m,d;return{id:`spotify:${i.id}`,title:i.name,artist:i.artists.map(o=>o.name).join(", "),artists:i.artists.map(o=>o.name),album:i.album.name,cover_url:(m=i.album.images[0])==null?void 0:m.url,artwork_url:(d=i.album.images[0])==null?void 0:d.url,duration_ms:i.duration_ms,spotify_id:i.id,provider:"spotify",external_id:i.id}}):s.status===401||s.status===403?(console.warn("[Spotify] top tracks forbidden/unauthorized; treating as disconnected"),[]):[]}catch(a){return console.error("Error fetching top tracks:",a),[]}}async function S(t,e="medium_term",r=20){const n=await h(t);if(!n)return[];try{const a=new URLSearchParams({time_range:e,limit:Math.min(r,50).toString()}),s=await fetch(`${_}/me/top/artists?${a}`,{headers:{Authorization:`Bearer ${n}`}});return s.ok?(await s.json()).items:s.status===401||s.status===403?(console.warn("[Spotify] top artists forbidden/unauthorized; treating as disconnected"),[]):[]}catch(a){return console.error("Error fetching top artists:",a),[]}}async function P(t,e){if(e.length===0)return[];const r=await h(t);if(!r)return[];try{const n=e.slice(0,100).join(","),a=await fetch(`${_}/audio-features?ids=${n}`,{headers:{Authorization:`Bearer ${r}`}});return a.ok?(await a.json()).audio_features.filter(Boolean):[]}catch(n){return console.error("Error fetching audio features:",n),[]}}async function B(t){const[e,r]=await Promise.all([b(t,"medium_term",50),S(t,"medium_term",50)]);if(e.length===0)return null;const n=e.map(l=>l.spotify_id||l.external_id).filter(Boolean),a=await P(t,n);if(a.length===0)return null;const s=a.reduce((l,u)=>l+u.energy,0)/a.length,c=a.reduce((l,u)=>l+u.danceability,0)/a.length,i=a.reduce((l,u)=>l+u.valence,0)/a.length,m=a.reduce((l,u)=>l+u.tempo,0)/a.length,d={};r.forEach(l=>{l.genres.forEach(u=>{d[u]=(d[u]||0)+1})});const o=Object.entries(d).sort((l,u)=>u[1]-l[1]).slice(0,10).map(([l,u])=>({genre:l,count:u}));let f="balanced";s>.7&&i>.6?f="energetic":s<.4&&i>.5?f="chill":i<.35?f="melancholic":i>.65&&c>.6&&(f="upbeat");const p=new Set(e.flatMap(l=>l.artists||[])),w=Math.min(p.size/e.length,1);return{topGenres:o,averageEnergy:s,averageDanceability:c,averageValence:i,averageTempo:m,moodProfile:f,listeningDiversity:w}}async function z(t,e=[],r=[],n=20){const a=await h(t);if(!a)return[];try{let s=e,c=r;if(s.length===0&&c.length===0){const[o,f]=await Promise.all([b(t,"medium_term",5),S(t,"medium_term",5)]);s=o.slice(0,2).map(p=>p.spotify_id||p.external_id).filter(Boolean),c=f.slice(0,3).map(p=>p.id)}const i=[];if(s.length>0&&i.push(`seed_tracks=${s.slice(0,2).join(",")}`),c.length>0&&i.push(`seed_artists=${c.slice(0,3).join(",")}`),i.length===0)return[];const m=await fetch(`${_}/recommendations?${i.join("&")}&limit=${n}`,{headers:{Authorization:`Bearer ${a}`}});return m.ok?(await m.json()).tracks.map(o=>{var f,p;return{id:`spotify:${o.id}`,title:o.name,artist:o.artists.map(w=>w.name).join(", "),artists:o.artists.map(w=>w.name),album:o.album.name,cover_url:(f=o.album.images[0])==null?void 0:f.url,artwork_url:(p=o.album.images[0])==null?void 0:p.url,duration_ms:o.duration_ms,spotify_id:o.id,provider:"spotify",external_id:o.id}}):[]}catch(s){return console.error("Error fetching recommendations:",s),[]}}function x(){const{user:t}=y();return g({queryKey:["spotify-connected",t==null?void 0:t.id],queryFn:()=>E(t.id),enabled:!!t,staleTime:5*60*1e3})}function U(t=20){const{user:e}=y();return g({queryKey:["spotify-recently-played",e==null?void 0:e.id,t],queryFn:()=>v(e.id,t),enabled:!!e,staleTime:2*60*1e3,refetchOnWindowFocus:!0})}function D(){const{user:t}=y();return g({queryKey:["spotify-profile",t==null?void 0:t.id],queryFn:()=>F(t.id),enabled:!!t,staleTime:10*60*1e3})}function L(t="medium_term",e=20){const{user:r}=y(),{data:n}=x();return g({queryKey:["spotify-top-tracks",r==null?void 0:r.id,t,e],queryFn:()=>b(r.id,t,e),enabled:!!r&&n===!0,staleTime:10*60*1e3})}function N(t="medium_term",e=20){const{user:r}=y(),{data:n}=x();return g({queryKey:["spotify-top-artists",r==null?void 0:r.id,t,e],queryFn:()=>S(r.id,t,e),enabled:!!r&&n===!0,staleTime:10*60*1e3})}function O(){const{user:t}=y(),{data:e}=x();return g({queryKey:["music-stats",t==null?void 0:t.id],queryFn:()=>B(t.id),enabled:!!t&&e===!0,staleTime:30*60*1e3})}function V(t=[],e=[],r=20){const{user:n}=y(),{data:a}=x();return g({queryKey:["spotify-recommendations",n==null?void 0:n.id,t,e,r],queryFn:()=>z(n.id,t,e,r),enabled:!!n&&a===!0,staleTime:15*60*1e3})}export{K as R,x as a,D as b,L as c,N as d,U as e,O as f,M as g,V as u};
