import{u}from"./useMutation-BDPdP8mj.js";import{a as d,s as g}from"./index-BVR2Ma7G.js";const a="harmony_hub_oauth_state",s="harmony_hub_oauth_verifier";function l(t){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",o=crypto.getRandomValues(new Uint8Array(t));return Array.from(o).map(r=>e[r%e.length]).join("")}async function f(t){const o=new TextEncoder().encode(t),r=await crypto.subtle.digest("SHA-256",o);return btoa(String.fromCharCode(...new Uint8Array(r))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}const m="https://accounts.spotify.com/authorize",y=["user-read-email","user-read-private","streaming","user-modify-playback-state","user-read-playback-state","user-read-currently-playing","user-read-recently-played","user-library-read","playlist-read-private","app-remote-control"].join(" ");function S(t,e){const o={state:t,codeVerifier:e,timestamp:Date.now()};localStorage.setItem(a,t),localStorage.setItem(s,JSON.stringify(o))}function w(){try{const t=localStorage.getItem(a),e=localStorage.getItem(s);if(!t||!e)return null;const o=JSON.parse(e);return Date.now()-o.timestamp>10*60*1e3?(h(),null):{state:o.state,codeVerifier:o.codeVerifier}}catch{return null}}function h(){localStorage.removeItem(a),localStorage.removeItem(s)}function A(){const{user:t}=d();return u({mutationFn:async()=>{if(console.log("[Spotify Connect] Starting OAuth flow..."),!t)throw new Error("Must be logged in to connect Spotify");const e="b1d936a5b2bd4cb199d3ede9a4fa2449";console.log("[Spotify Connect] Client ID:",`${e.substring(0,8)}...`);const o=l(64),r=await f(o),n=l(32);S(n,o),console.log("[Spotify Connect] State stored:",n.substring(0,8)+"...");const c="https://repoisrael.github.io/cladeai/spotify-callback";console.log("[Spotify Connect] Redirect URI:",c);const p=new URLSearchParams({client_id:e,response_type:"code",redirect_uri:c,scope:y,state:n,code_challenge_method:"S256",code_challenge:r}),i=`${m}?${p.toString()}`;console.log("[Spotify Connect] Redirecting to:",i.substring(0,80)+"..."),window.location.href=i}})}function C(){const{user:t}=d();return u({mutationFn:async()=>{if(!t)throw new Error("Must be logged in");const{error:e}=await g.from("user_providers").delete().eq("user_id",t.id).eq("provider","spotify");if(e)throw e}})}export{C as a,h as c,w as g,A as u};
