import{U as N,u as E,a as P,r as p,j as e,L as R,B as S,s as T}from"./index-c329HF_1.js";import{g as O,c as w}from"./useSpotifyConnect-D1Lq2NVM.js";import{C as U}from"./circle-check-qTdDpbOH.js";import{C as A}from"./circle-alert-CcAQqgvQ.js";import"./useMutation-D798oNfM.js";const F="https://accounts.spotify.com/api/token";function B(){const[t]=N(),a=E(),{user:n}=P(),[c,u]=p.useState("loading"),[k,b]=p.useState("");return p.useEffect(()=>{async function j(){var h;try{console.log("[Spotify Callback] Starting..."),console.log("[Spotify Callback] URL params:",Object.fromEntries(t.entries()));const o=t.get("code"),s=t.get("state"),l=t.get("error"),g=t.get("error_description");if(l)throw console.error("[Spotify Callback] Spotify error:",l,g),new Error(g||`Spotify authorization failed: ${l}`);if(!o||!s)throw console.error("[Spotify Callback] Missing code or state"),new Error("Missing authorization code or state");const r=O();if(console.log("[Spotify Callback] Stored state:",((h=r==null?void 0:r.state)==null?void 0:h.substring(0,8))+"..."),console.log("[Spotify Callback] Received state:",(s==null?void 0:s.substring(0,8))+"..."),!r||r.state!==s)throw console.error("[Spotify Callback] State mismatch"),new Error("Invalid state parameter. Please try connecting again.");if(!n)throw console.error("[Spotify Callback] No user logged in"),new Error("You must be logged in to connect Spotify");console.log("[Spotify Callback] Exchanging code for tokens...");const C="b1d936a5b2bd4cb199d3ede9a4fa2449",m="https://repoisrael.github.io/cladeai/spotify-callback";console.log("[Spotify Callback] Using redirect URI:",m);const d=await fetch(F,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"authorization_code",code:o,redirect_uri:m,client_id:C,code_verifier:r.codeVerifier})});if(!d.ok){const f=await d.json();throw console.error("[Spotify Callback] Token exchange failed:",f),new Error(f.error_description||`Token exchange failed: ${f.error}`)}console.log("[Spotify Callback] Token exchange successful");const i=await d.json();console.log("[Spotify Callback] Fetching Spotify profile...");const x=await fetch("https://api.spotify.com/v1/me",{headers:{Authorization:`Bearer ${i.access_token}`}});if(!x.ok)throw new Error("Failed to fetch Spotify profile");const v=await x.json(),_=new Date(Date.now()+i.expires_in*1e3).toISOString(),{error:y}=await T.from("user_providers").upsert({user_id:n.id,provider:"spotify",provider_user_id:v.id,access_token:i.access_token,refresh_token:i.refresh_token,expires_at:_,connected_at:new Date().toISOString()},{onConflict:"user_id,provider"});if(y)throw console.error("Failed to store Spotify connection:",y),new Error("Failed to save Spotify connection");w(),u("success"),setTimeout(()=>{a("/profile",{replace:!0})},2e3)}catch(o){console.error("Spotify callback error:",o),b(o instanceof Error?o.message:"Unknown error"),u("error"),w()}}j()},[t,n,a]),e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs("div",{className:"max-w-md w-full text-center",children:[c==="loading"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx(R,{size:"lg"}),e.jsx("h2",{className:"text-xl font-semibold",children:"Connecting to Spotify..."}),e.jsx("p",{className:"text-muted-foreground",children:"Please wait while we complete the connection"})]}),c==="success"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-green-500/20 flex items-center justify-center mx-auto",children:e.jsx(U,{className:"w-8 h-8 text-green-500"})}),e.jsx("h2",{className:"text-xl font-semibold text-green-500",children:"Spotify Connected!"}),e.jsx("p",{className:"text-muted-foreground",children:"Redirecting to your profile..."})]}),c==="error"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-destructive/20 flex items-center justify-center mx-auto",children:e.jsx(A,{className:"w-8 h-8 text-destructive"})}),e.jsx("h2",{className:"text-xl font-semibold text-destructive",children:"Connection Failed"}),e.jsx("p",{className:"text-muted-foreground",children:k}),e.jsxs("div",{className:"flex gap-2 justify-center mt-4",children:[e.jsx(S,{variant:"outline",onClick:()=>a("/profile"),children:"Go to Profile"}),e.jsx(S,{onClick:()=>a("/profile"),children:"Try Again"})]})]})]})})}export{B as default};
