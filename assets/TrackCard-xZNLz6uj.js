import{c as A,j as e,m as g,r as x,b as w,X as J,af as he,a as M,s as _,h as V,i as ee,u as se,B as C,g as xe,k as fe,d as te,P as ae,ag as ge,Q as ye}from"./index-Djud7ByU.js";import{C as be}from"./ChordBadge-Bptbx8Oj.js";import{K as je,R as we}from"./rotate-ccw-BS9o1-4V.js";import{M as Ne}from"./music-sJrrR1HR.js";import{D as ve,a as _e,E as Ce,b as Se,c as T,d as Y,T as Me}from"./TrackComments-sds4i_WT.js";import{O as ie,C as ne,a as Pe,T as re,D as oe,P as ke,R as Te,b as Ae,S as Re}from"./switch-Bb6NfSCy.js";import{A as Ie,a as ze,b as $e}from"./avatar-BY4hebTo.js";import{S as qe}from"./scroll-area-BGs96uJX.js";import{S as De,b as Le}from"./useFollowing-CQ0YF8eX.js";import{L as X}from"./label-oZaHZSq8.js";import{u as F}from"./useMutation-BkEs0-PX.js";import{U as O}from"./users-wWRpjEuz.js";import{A as U}from"./index-CU_qgXc9.js";import{M as q}from"./map-pin-cP2ZAnNs.js";import{R as Oe}from"./radio-BPurDKku.js";import{f as Ee}from"./formatDistanceToNow-3UBXKcFR.js";import{S as E}from"./share-2-DaYwD1wj.js";import{C as Ue}from"./check-CoTfArUT.js";import{T as Ve}from"./twitter-xlyPvbn0.js";import{M as Fe,S as Qe}from"./send-B2X-zINU.js";import{Q as Ke}from"./QuickStreamButtons-CA4jE52U.js";import{a as Z}from"./timeFormat-BXo_t6_Q.js";import{L as He,U as Be}from"./BottomNav-CxsfTDIy.js";import{M as We}from"./music-2-CmJg9-px.js";import{A as Ye}from"./CladeIcon-Bd1TI5Om.js";import{S as Xe}from"./sparkles-BFF6S3yB.js";import{H as Ze}from"./heart-DzDTEwI4.js";import{W as Ge}from"./waves-0BcqoMf1.js";import{B as Je}from"./bookmark-Cwdajlcf.js";import{M as es}from"./search-LENj6gJG.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ss=A("Album",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["polyline",{points:"11 3 11 11 14 8 17 11 17 3",key:"1wcwz3"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ts=A("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const le=A("Link2",[["path",{d:"M9 17H7A5 5 0 0 1 7 7h2",key:"8i5ue5"}],["path",{d:"M15 7h2a5 5 0 1 1 0 10h-2",key:"1b9ql8"}],["line",{x1:"8",x2:"16",y1:"12",y2:"12",key:"1jonct"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const as=A("Settings2",[["path",{d:"M20 7h-9",key:"3s1dr2"}],["path",{d:"M14 17H5",key:"gfn3mx"}],["circle",{cx:"17",cy:"17",r:"3",key:"18b49y"}],["circle",{cx:"7",cy:"7",r:"3",key:"dfmy0x"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const is=A("SquarePlay",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"m9 8 6 4-6 4Z",key:"f1r3lt"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ns=A("Youtube",[["path",{d:"M2.5 17a24.12 24.12 0 0 1 0-10 2 2 0 0 1 1.4-1.4 49.56 49.56 0 0 1 16.2 0A2 2 0 0 1 21.5 7a24.12 24.12 0 0 1 0 10 2 2 0 0 1-1.4 1.4 49.55 49.55 0 0 1-16.2 0A2 2 0 0 1 2.5 17",key:"1q2vi4"}],["path",{d:"m10 15 5-3-5-3z",key:"1jp15x"}]]);function rs({progression:s,detectedKey:t,detectedMode:a,cadenceType:i,confidenceScore:o,matchReason:p}){return e.jsxs(g.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"glass-strong rounded-2xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(je,{className:"w-4 h-4"}),e.jsxs("span",{className:"text-sm font-medium",children:[t||"Unknown"," ",a&&a!=="unknown"?a:""]})]}),i&&i!=="none"&&e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-muted-foreground",children:[e.jsx(we,{className:"w-3 h-3"}),e.jsx("span",{className:"capitalize",children:i})]})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(Ne,{className:"w-4 h-4 text-primary shrink-0"}),e.jsx("div",{className:"flex flex-wrap gap-1.5",children:s.map((m,d)=>e.jsx(g.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},transition:{delay:d*.05},children:e.jsx(be,{chord:m,size:"md",keySignature:t})},d))})]}),p&&e.jsx("p",{className:"text-xs text-muted-foreground leading-relaxed pt-1 border-t border-border/50",children:p}),o!==void 0&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex-1 h-1 bg-muted rounded-full overflow-hidden",children:e.jsx(g.div,{initial:{width:0},animate:{width:`${o*100}%`},transition:{delay:.3,duration:.5},className:"h-full bg-gradient-to-r from-primary to-accent rounded-full"})}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[Math.round(o*100),"%"]})]})]})}const de=Te,ce=Ae,os=ke,me=x.forwardRef(({className:s,...t},a)=>e.jsx(ie,{className:w("fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",s),...t,ref:a}));me.displayName=ie.displayName;const ls=he("fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500",{variants:{side:{top:"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",bottom:"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",left:"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",right:"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm"}},defaultVariants:{side:"right"}}),Q=x.forwardRef(({side:s="right",className:t,children:a,...i},o)=>e.jsxs(os,{children:[e.jsx(me,{}),e.jsxs(ne,{ref:o,className:w(ls({side:s}),t),...i,children:[a,e.jsxs(Pe,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity data-[state=open]:bg-secondary hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none",children:[e.jsx(J,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Close"})]})]})]}));Q.displayName=ne.displayName;const K=({className:s,...t})=>e.jsx("div",{className:w("flex flex-col space-y-2 text-center sm:text-left",s),...t});K.displayName="SheetHeader";const H=x.forwardRef(({className:s,...t},a)=>e.jsx(re,{ref:a,className:w("text-lg font-semibold text-foreground",s),...t}));H.displayName=re.displayName;const ds=x.forwardRef(({className:s,...t},a)=>e.jsx(oe,{ref:a,className:w("text-sm text-muted-foreground",s),...t}));ds.displayName=oe.displayName;function G(s,t,a,i){const p=(a-s)*Math.PI/180,m=(i-t)*Math.PI/180,d=Math.sin(p/2)*Math.sin(p/2)+Math.cos(s*Math.PI/180)*Math.cos(a*Math.PI/180)*Math.sin(m/2)*Math.sin(m/2);return 6371*(2*Math.atan2(Math.sqrt(d),Math.sqrt(1-d)))}function ue(){const{user:s}=M();return V({queryKey:["user-location",s==null?void 0:s.id],queryFn:async()=>{if(!s)return null;const{data:t,error:a}=await _.from("user_locations").select("*").eq("user_id",s.id).maybeSingle();if(a)throw a;return t},enabled:!!s})}function cs(){const s=ee(),{user:t}=M();return F({mutationFn:async({latitude:a,longitude:i,sharingEnabled:o=!0,radiusKm:p=50})=>{if(!t)throw new Error("Must be logged in");const{data:m,error:d}=await _.from("user_locations").upsert({user_id:t.id,latitude:a,longitude:i,sharing_enabled:o,radius_km:p}).select().single();if(d)throw d;return m},onSuccess:()=>{s.invalidateQueries({queryKey:["user-location"]}),s.invalidateQueries({queryKey:["nearby-listeners"]})}})}function ms(){const s=ee(),{user:t}=M();return F({mutationFn:async()=>{if(!t)throw new Error("Must be logged in");const{error:a}=await _.from("user_locations").update({sharing_enabled:!1}).eq("user_id",t.id);if(a)throw a},onSuccess:()=>{s.invalidateQueries({queryKey:["user-location"]})}})}function us(s,t){const{user:a}=M(),{data:i}=ue();return V({queryKey:["nearby-listeners",s,t,i==null?void 0:i.latitude,i==null?void 0:i.longitude],queryFn:async()=>{if(!a||!(i!=null&&i.sharing_enabled))return[];const{data:o,error:p}=await _.from("user_locations").select("user_id, latitude_fuzzy, longitude_fuzzy").eq("sharing_enabled",!0).neq("user_id",a.id);if(p)throw p;const m=(o||[]).filter(r=>G(i.latitude,i.longitude,Number(r.latitude_fuzzy),Number(r.longitude_fuzzy))<=i.radius_km).map(r=>({user_id:r.user_id,distance_km:G(i.latitude,i.longitude,Number(r.latitude_fuzzy),Number(r.longitude_fuzzy))}));if(m.length===0)return[];const{data:d,error:h}=await _.from("profiles").select("id, display_name, avatar_url").in("id",m.map(r=>r.user_id));if(h)throw h;let b=[];if(s||t){let r=_.from("nearby_activity").select("*").in("user_id",m.map(n=>n.user_id)).order("listened_at",{ascending:!1});if(s&&(r=r.eq("track_id",s)),t){const n=t.replace(/[%_]/g,"\\$&");r=r.ilike("artist",`%${n}%`)}const{data:l}=await r;b=l||[]}return m.map(({user_id:r,distance_km:l})=>{const n=(d||[]).find(y=>y.id===r),u=b.find(y=>y.user_id===r);return{user_id:r,display_name:(n==null?void 0:n.display_name)||"Anonymous",avatar_url:n==null?void 0:n.avatar_url,distance_km:Math.round(l*10)/10,last_track:u==null?void 0:u.track_id,last_artist:u==null?void 0:u.artist,listened_at:u==null?void 0:u.listened_at}}).filter(r=>!s&&!t?!0:b.some(l=>l.user_id===r.user_id)).sort((r,l)=>r.distance_km-l.distance_km)},enabled:!!a&&!!(i!=null&&i.sharing_enabled)})}function ps(){const{user:s}=M();return F({mutationFn:async({trackId:t,artist:a})=>{if(!s)return;const{error:i}=await _.from("nearby_activity").insert({user_id:s.id,track_id:t,artist:a||null});if(i)throw i}})}function hs({trackId:s,artist:t,trackTitle:a}){const[i,o]=x.useState(!1),[p,m]=x.useState(!1),[d,h]=x.useState(50),[b,j]=x.useState(!1),{user:r}=M(),l=se(),{data:n,isLoading:u}=ue(),{data:y=[],isLoading:S}=us(s,t),N=cs(),z=ms();x.useEffect(()=>{n!=null&&n.radius_km&&h(n.radius_km)},[n==null?void 0:n.radius_km]);const $=async()=>{if(!r){l("/auth");return}j(!0);try{const c=await new Promise((v,k)=>{navigator.geolocation.getCurrentPosition(v,k,{enableHighAccuracy:!1,timeout:1e4,maximumAge:3e5})});await N.mutateAsync({latitude:c.coords.latitude,longitude:c.coords.longitude,sharingEnabled:!0,radiusKm:d})}catch(c){console.error("Location error:",c)}finally{j(!1)}},D=async c=>{const v=c[0];h(v),n&&await N.mutateAsync({latitude:n.latitude,longitude:n.longitude,sharingEnabled:!0,radiusKm:v})},L=async c=>{c&&!n?await $():c?n&&await N.mutateAsync({latitude:n.latitude,longitude:n.longitude,sharingEnabled:c,radiusKm:d}):await z.mutateAsync()},P=(n==null?void 0:n.sharing_enabled)??!1;return e.jsxs(de,{open:i,onOpenChange:o,children:[e.jsx(ce,{asChild:!0,children:e.jsxs(g.button,{whileTap:{scale:.9},className:"flex flex-col items-center gap-1 p-3 rounded-xl transition-all text-muted-foreground hover:text-foreground",children:[e.jsxs("div",{className:"p-3 rounded-full bg-muted/50 hover:bg-muted transition-all relative",children:[e.jsx(O,{className:"w-6 h-6"}),P&&y.length>0&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-accent text-accent-foreground text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center",children:y.length})]}),e.jsx("span",{className:"text-xs font-medium",children:"Nearby"})]})}),e.jsxs(Q,{side:"bottom",className:"h-[80vh] rounded-t-3xl",children:[e.jsx(K,{className:"pb-4 border-b border-border",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(H,{className:"flex items-center gap-2",children:[e.jsx(O,{className:"w-5 h-5 text-accent"}),a?`Listeners of "${a}"`:"Nearby Music Lovers"]}),e.jsx(C,{variant:"ghost",size:"icon",onClick:()=>m(!p),className:"h-8 w-8",children:e.jsx(as,{className:"w-4 h-4"})})]})}),e.jsx(U,{children:p&&e.jsx(g.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},className:"overflow-hidden border-b border-border",children:e.jsxs("div",{className:"py-4 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(q,{className:"w-4 h-4 text-primary"}),e.jsx(X,{htmlFor:"location-sharing",children:"Share my location"})]}),e.jsx(Re,{id:"location-sharing",checked:P,onCheckedChange:L,disabled:N.isPending||z.isPending})]}),P&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(X,{children:"Discovery radius"}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[d," km"]})]}),e.jsx(De,{value:[d],onValueChange:D,min:5,max:100,step:5,className:"w-full"})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Your location is only visible to others who also share theirs."})]})})}),e.jsx("div",{className:"flex flex-col h-[calc(80vh-10rem)]",children:e.jsx(qe,{className:"flex-1 py-4",children:r?P?S||u?e.jsx("div",{className:"space-y-4",children:[1,2,3].map(c=>e.jsxs("div",{className:"flex gap-3 animate-pulse",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-muted"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("div",{className:"h-4 w-32 bg-muted rounded"}),e.jsx("div",{className:"h-3 w-24 bg-muted rounded"})]})]},c))}):y.length===0?e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(Oe,{className:"w-12 h-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"No listeners nearby yet"}),e.jsx("p",{className:"text-sm",children:"Check back later or expand your radius"})]}):e.jsx(U,{mode:"popLayout",children:y.map((c,v)=>{var k;return e.jsxs(g.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:v*.05},className:"flex gap-3 mb-4 p-3 rounded-xl glass hover:bg-muted/30 transition-colors",children:[e.jsxs(Ie,{className:"w-12 h-12",children:[e.jsx(ze,{src:c.avatar_url}),e.jsx($e,{className:"bg-accent/20 text-accent",children:((k=c.display_name)==null?void 0:k.charAt(0).toUpperCase())||"A"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:c.display_name}),e.jsxs("span",{className:"text-xs text-muted-foreground flex items-center gap-1",children:[e.jsx(q,{className:"w-3 h-3"}),c.distance_km," km"]})]}),c.last_artist&&e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:["Recently listened to ",c.last_artist]}),c.listened_at&&e.jsx("p",{className:"text-xs text-muted-foreground",children:Ee(new Date(c.listened_at),{addSuffix:!0})})]})]},c.user_id)})}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(q,{className:"w-12 h-12 mx-auto mb-3 text-muted-foreground opacity-50"}),e.jsx("p",{className:"text-muted-foreground mb-2",children:"Enable location sharing"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Discover people nearby who love the same music"}),e.jsxs(C,{onClick:$,disabled:b,className:"gap-2",children:[b?e.jsx(xe,{className:"w-4 h-4 animate-spin"}):e.jsx(q,{className:"w-4 h-4"}),"Enable Location"]})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(O,{className:"w-12 h-12 mx-auto mb-3 text-muted-foreground opacity-50"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Sign in to discover nearby listeners"}),e.jsx(C,{onClick:()=>l("/auth"),children:"Sign In"})]})})})]})]})}function xs({track:s,onShare:t}){const[a,i]=x.useState(!1),[o,p]=x.useState(!1),{toast:m}=fe(),d=`${window.location.origin}/track/${s.id}`,h=`Check out "${s.title}" by ${s.artist} on HarmonyFeed! ðŸŽµ`,b=async()=>{try{await navigator.clipboard.writeText(d),p(!0),m({title:"Link copied!"}),setTimeout(()=>p(!1),2e3),t==null||t()}catch{m({title:"Failed to copy",variant:"destructive"})}},j=async()=>{if(navigator.share)try{await navigator.share({title:s.title,text:h,url:d}),t==null||t(),i(!1)}catch{}},r=[{name:"Copy Link",icon:o?Ue:ts,onClick:b,className:o?"text-green-500":""},{name:"Twitter/X",icon:Ve,onClick:()=>{window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(h)}&url=${encodeURIComponent(d)}`,"_blank"),t==null||t()}},{name:"WhatsApp",icon:Fe,onClick:()=>{window.open(`https://wa.me/?text=${encodeURIComponent(h+" "+d)}`,"_blank"),t==null||t()}},{name:"Telegram",icon:Qe,onClick:()=>{window.open(`https://t.me/share/url?url=${encodeURIComponent(d)}&text=${encodeURIComponent(h)}`,"_blank"),t==null||t()}}];return e.jsxs(de,{open:a,onOpenChange:i,children:[e.jsx(ce,{asChild:!0,children:e.jsxs(C,{variant:"ghost",size:"sm",className:"text-muted-foreground hover:text-foreground gap-2",children:[e.jsx(E,{className:"w-4 h-4"}),"Share"]})}),e.jsxs(Q,{side:"bottom",className:"rounded-t-3xl",children:[e.jsx(K,{className:"pb-4",children:e.jsxs(H,{className:"flex items-center gap-2",children:[e.jsx(E,{className:"w-5 h-5 text-primary"}),'Share "',s.title,'"']})}),e.jsxs("div",{className:"space-y-4 pb-8",children:[e.jsxs("div",{className:"flex gap-3 p-3 rounded-xl glass",children:[s.cover_url?e.jsx("img",{src:s.cover_url,alt:"",className:"w-16 h-16 rounded-lg object-cover"}):e.jsx("div",{className:"w-16 h-16 rounded-lg bg-muted flex items-center justify-center",children:e.jsx(le,{className:"w-6 h-6 text-muted-foreground"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-medium truncate",children:s.title}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:s.artist})]})]}),typeof navigator<"u"&&"share"in navigator&&e.jsxs(C,{onClick:j,className:"w-full gap-2",variant:"default",children:[e.jsx(E,{className:"w-4 h-4"}),"Share"]}),e.jsx("div",{className:"grid grid-cols-4 gap-3",children:r.map(l=>e.jsxs(g.button,{whileTap:{scale:.95},onClick:l.onClick,className:"flex flex-col items-center gap-2 p-3 rounded-xl hover:bg-muted/50 transition-colors",children:[e.jsx("div",{className:`p-3 rounded-full bg-muted ${l.className||""}`,children:e.jsx(l.icon,{className:"w-5 h-5"})}),e.jsx("span",{className:"text-xs text-muted-foreground",children:l.name})]},l.name))})]})]})]})}const fs={intro:"bg-blue-500/20 text-blue-300 border-blue-500/30",verse:"bg-purple-500/20 text-purple-300 border-purple-500/30","pre-chorus":"bg-pink-500/20 text-pink-300 border-pink-500/30",chorus:"bg-green-500/20 text-green-300 border-green-500/30",bridge:"bg-orange-500/20 text-orange-300 border-orange-500/30",outro:"bg-red-500/20 text-red-300 border-red-500/30",breakdown:"bg-yellow-500/20 text-yellow-300 border-yellow-500/30",drop:"bg-cyan-500/20 text-cyan-300 border-cyan-500/30"};function gs({sections:s,youtubeId:t,spotifyId:a,trackTitle:i,trackArtist:o,canonicalTrackId:p=null,className:m}){const{openPlayer:d,seekTo:h,youtubeOpen:b,youtubeTrackId:j,spotifyOpen:r,spotifyTrackId:l}=te(),n=u=>{const y=Math.floor(u.start_ms/1e3),S=b&&(j==null?void 0:j.includes(t||""));t?S?h(y):d({canonicalTrackId:null,provider:"youtube",providerTrackId:t,autoplay:!0,startSec:y}):a&&!(r&&l===a)&&d({canonicalTrackId:null,provider:"spotify",providerTrackId:a,autoplay:!0})};return!s||s.length===0?null:e.jsx("div",{className:w("flex gap-1.5 flex-wrap",m),children:s.map((u,y)=>{const S=fs[u.label]||"bg-muted/20 text-muted-foreground border-muted/30";return e.jsx(g.button,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},transition:{delay:y*.03},onClick:()=>n(u),className:w("group relative px-2 py-1 rounded-md text-xs font-medium","border transition-all hover:scale-105",S),title:`Play from ${u.label} at ${Z(u.start_ms)}`,children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ae,{className:"w-2.5 h-2.5 opacity-0 group-hover:opacity-100 transition-opacity"}),e.jsx("span",{className:"capitalize",children:u.label}),e.jsx("span",{className:"text-[10px] opacity-60",children:Z(u.start_ms)})]})},u.id)})})}function ys({track:s}){const t=se(),{playNext:a,playLater:i}=ge(),o=()=>{s.album&&t(`/album/${encodeURIComponent(s.album)}`)},p=()=>{s.artist&&t(`/artist/${encodeURIComponent(s.artist)}`)},m=()=>{if(s.progression_roman){const h=s.progression_roman.join("-");t(`/search?mode=chord&q=${encodeURIComponent(h)}`)}},d=()=>{t(`/connections/${encodeURIComponent(s.id)}`)};return e.jsxs(ve,{children:[e.jsx(_e,{asChild:!0,children:e.jsx(C,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:h=>h.stopPropagation(),children:e.jsx(Ce,{className:"w-4 h-4"})})}),e.jsxs(Se,{align:"end",className:"w-56",children:[e.jsxs(T,{onClick:()=>a(s),children:[e.jsx(is,{className:"w-4 h-4 mr-2"}),"Play Next"]}),e.jsxs(T,{onClick:()=>i(s),children:[e.jsx(He,{className:"w-4 h-4 mr-2"}),"Add to Queue"]}),e.jsx(Y,{}),s.album&&e.jsxs(T,{onClick:o,children:[e.jsx(ss,{className:"w-4 h-4 mr-2"}),"View Album"]}),s.artist&&e.jsxs(T,{onClick:p,children:[e.jsx(Be,{className:"w-4 h-4 mr-2"}),"View Artist"]}),e.jsx(Y,{}),s.progression_roman&&s.progression_roman.length>0&&e.jsxs(T,{onClick:m,children:[e.jsx(We,{className:"w-4 h-4 mr-2"}),"Similar Chord Progressions"]}),e.jsxs(T,{onClick:d,children:[e.jsx(le,{className:"w-4 h-4 mr-2"}),"View Samples & Connections"]})]})]})}function bs(s){return V({queryKey:["track-comments",s],queryFn:async()=>{const{data:t,error:a}=await _.from("track_comments").select(`
          *,
          profiles:user_id (
            display_name,
            avatar_url
          )
        `).eq("track_id",s).order("created_at",{ascending:!0});if(a)throw a;return(t||[]).map(i=>{var o,p;return{...i,user_display_name:((o=i.profiles)==null?void 0:o.display_name)||"Anonymous",user_avatar_url:(p=i.profiles)==null?void 0:p.avatar_url}})},enabled:!!s})}function Xs({track:s,isActive:t,onInteraction:a,interactions:i=new Set,onPipModeActivate:o,isPipActive:p=!1}){const{user:m,guestMode:d}=M(),[h,b]=x.useState(!1),[j,r]=x.useState(!1),l=x.useRef(null),n=x.useRef(null),u=ps(),y=Le(),{openPlayer:S}=te(),{data:N}=bs(s.id),z=(N==null?void 0:N.length)||0,$=x.useCallback(f=>f.map((R,B)=>{var W;return{id:`${s.id}-${R.type}-${B}`,track_id:s.id,label:R.type,start_ms:R.start_time*1e3,end_ms:R.end_time?R.end_time*1e3:(((W=f[B+1])==null?void 0:W.start_time)||s.duration_ms||24e4/1e3)*1e3,created_at:new Date().toISOString()}}),[s.id,s.duration_ms]),D=x.useCallback(()=>{const f=s.duration_ms||24e4;return[{id:`${s.id}-intro`,track_id:s.id,label:"intro",start_ms:0,end_ms:Math.floor(f*.1),created_at:new Date().toISOString()},{id:`${s.id}-verse1`,track_id:s.id,label:"verse",start_ms:Math.floor(f*.1),end_ms:Math.floor(f*.3),created_at:new Date().toISOString()},{id:`${s.id}-chorus1`,track_id:s.id,label:"chorus",start_ms:Math.floor(f*.3),end_ms:Math.floor(f*.5),created_at:new Date().toISOString()},{id:`${s.id}-verse2`,track_id:s.id,label:"verse",start_ms:Math.floor(f*.5),end_ms:Math.floor(f*.65),created_at:new Date().toISOString()},{id:`${s.id}-chorus2`,track_id:s.id,label:"chorus",start_ms:Math.floor(f*.65),end_ms:Math.floor(f*.85),created_at:new Date().toISOString()},{id:`${s.id}-outro`,track_id:s.id,label:"outro",start_ms:Math.floor(f*.85),end_ms:f,created_at:new Date().toISOString()}]},[s.id,s.duration_ms]),L=s.sections&&s.sections.length>0?$(s.sections):D();x.useEffect(()=>{!t&&h&&c()},[t]),x.useEffect(()=>()=>{l.current&&l.current.pause()},[]);const P=x.useCallback(async()=>{if(l.current&&s.preview_url)try{await l.current.play(),b(!0),n.current=Date.now(),u.mutate({trackId:s.id,artist:s.artist})}catch(f){console.error("Playback failed:",f)}},[s.preview_url,s.id,s.artist,u]),c=x.useCallback(()=>{if(l.current&&(l.current.pause(),b(!1),n.current&&m)){const f=Date.now()-n.current;y.mutate({trackId:s.id,durationMs:f,source:"feed"}),n.current=null}},[m,s.id,y]),v=()=>{h?c():P()},k=()=>{if(b(!1),n.current&&m){const f=Date.now()-n.current;y.mutate({trackId:s.id,durationMs:f,source:"feed"}),n.current=null}},pe=()=>{a("share")};return e.jsxs(g.div,{initial:{opacity:0},animate:{opacity:t?1:.5},className:"relative w-full h-full flex flex-col","data-track-card":s.id,children:[s.preview_url&&e.jsx("audio",{ref:l,src:s.preview_url,preload:"none",onEnded:k}),e.jsx("div",{className:"absolute inset-0 z-0",children:s.cover_url?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:s.cover_url,alt:"",className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-background via-background/80 to-background/40"})]}):e.jsx("div",{className:"w-full h-full bg-gradient-to-br from-secondary to-background"})}),e.jsxs("div",{className:"relative z-10 flex-1 flex flex-col justify-end p-6 pb-8 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs(g.h2,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},className:"text-2xl font-bold text-foreground line-clamp-2 flex-1 flex items-center gap-2",children:[e.jsx("span",{children:s.title}),s.is_common_ancestor&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-gradient-to-r from-amber-500/20 to-orange-500/20 border border-amber-500/30",title:"Common Ancestor - Foundational track that influenced a musical movement",children:[e.jsx(Ye,{size:14,className:"text-amber-400"}),e.jsx("span",{className:"text-[10px] font-semibold text-amber-400 uppercase tracking-wide",children:"Ancestor"})]})]}),e.jsx(ys,{track:s})]}),e.jsx(g.p,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.05},className:"text-lg text-muted-foreground",children:s.artist}),(s.tempo||s.genre)&&e.jsxs(g.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.07},className:"flex items-center gap-2 text-sm text-muted-foreground",children:[s.tempo&&e.jsxs("span",{className:"font-medium",children:[Math.round(s.tempo)," BPM"]}),s.tempo&&s.genre&&e.jsx("span",{children:"â€¢"}),s.genre&&e.jsx("span",{className:"capitalize",children:s.genre})]})]}),e.jsx(g.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.08},children:e.jsx(gs,{sections:L,youtubeId:s.youtube_id,spotifyId:s.spotify_id,trackTitle:s.title,trackArtist:s.artist||"",canonicalTrackId:s.id})}),e.jsxs(g.div,{initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},transition:{delay:.1},className:"flex items-center gap-3",children:[s.preview_url&&e.jsxs(C,{variant:"outline",size:"lg",onClick:v,className:"gap-2 glass border-white/20 hover:bg-white/10",children:[h?e.jsx(ye,{className:"w-5 h-5"}):e.jsx(ae,{className:"w-5 h-5"}),h?"Pause":"Preview"]}),s.youtube_id&&e.jsxs(C,{variant:"outline",size:"lg",onClick:()=>S({canonicalTrackId:s.id,provider:"youtube",providerTrackId:s.youtube_id,autoplay:!0,context:"feed-card-watch",title:s.title,artist:s.artist}),className:"gap-2 glass border-white/20 hover:bg-white/10",children:[e.jsx(ns,{className:"w-5 h-5"}),"Watch"]}),e.jsx(Ke,{track:{spotifyId:s.spotify_id||void 0,youtubeId:s.youtube_id||void 0,urlSpotifyWeb:s.url_spotify_web||void 0,urlSpotifyApp:s.url_spotify_app||void 0,urlYoutube:s.url_youtube||void 0},canonicalTrackId:s.id,trackTitle:s.title,trackArtist:s.artist,size:"md"})]}),s.progression_roman&&s.progression_roman.length>0&&e.jsx(g.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.15},children:e.jsx(rs,{progression:s.progression_roman,detectedKey:s.detected_key,detectedMode:s.detected_mode,cadenceType:s.cadence_type,confidenceScore:s.confidence_score,matchReason:"Same viâ€“IVâ€“Iâ€“V loop with similar energy"})}),e.jsxs(g.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.2},className:"flex items-center justify-between pt-4 relative z-20",children:[e.jsx(I,{icon:J,label:"Skip",isActive:i.has("skip"),onClick:()=>a("skip"),variant:"muted"}),e.jsx(I,{icon:Xe,label:"Harmonic",isActive:i.has("more_harmonic"),onClick:()=>a("more_harmonic"),variant:"primary"}),e.jsx(I,{icon:Ze,label:"Like",isActive:i.has("like"),onClick:()=>a("like"),variant:"accent"}),e.jsx(I,{icon:Ge,label:"Vibe",isActive:i.has("more_vibe"),onClick:()=>a("more_vibe"),variant:"primary"}),e.jsx(I,{icon:Je,label:"Save",isActive:i.has("save"),onClick:()=>a("save"),variant:"muted"})]}),e.jsxs(g.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.25},className:"flex items-center justify-center gap-4",children:[e.jsxs(g.button,{whileTap:{scale:.9},onClick:()=>r(!j),className:"flex items-center gap-2 px-4 py-2 rounded-full bg-muted/50 hover:bg-muted transition-all text-muted-foreground hover:text-foreground",children:[e.jsx(es,{className:"w-5 h-5"}),e.jsx("span",{className:"text-sm font-medium",children:z})]}),e.jsx(hs,{trackId:s.id,artist:s.artist,trackTitle:s.title}),e.jsx(xs,{track:s,onShare:pe})]}),e.jsx(U,{children:j&&e.jsx(g.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:.3},className:"overflow-hidden",children:e.jsx("div",{className:"mt-6 pt-6 border-t border-border/50",children:e.jsx(Me,{trackId:s.id})})})})]})]})}function I({icon:s,label:t,isActive:a,onClick:i,variant:o}){return e.jsxs(g.button,{whileTap:{scale:.9},onClick:i,className:w("flex flex-col items-center gap-1 p-3 rounded-xl transition-all",a&&o==="accent"&&"text-accent glow-accent",a&&o==="primary"&&"text-primary glow-primary",a&&o==="muted"&&"text-foreground",!a&&"text-muted-foreground hover:text-foreground"),children:[e.jsx("div",{className:w("p-3 rounded-full transition-all",a&&o==="accent"&&"bg-accent/20",a&&o==="primary"&&"bg-primary/20",a&&o==="muted"&&"bg-muted",!a&&"bg-muted/50 hover:bg-muted"),children:e.jsx(s,{className:w("w-6 h-6",a&&o==="accent"&&"fill-current")})}),e.jsx("span",{className:"text-xs font-medium",children:t})]})}export{Xs as T};
